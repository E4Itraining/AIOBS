# =============================================================================
# AIOBS - AI Observability Hub
# Docker Compose Configuration for Full Stack Deployment
# =============================================================================
#
# Quick Start:
#   docker-compose up -d
#
# Services:
#   - visualization: FastAPI Dashboard (port 8000)
#   - backend: TypeScript Core Platform (port 3000)
#   - victoriametrics: Time-series metrics database (port 8428)
#   - openobserve: Logs, traces, compliance storage (port 5080)
#   - redis: Caching and real-time pub/sub (port 6379)
#   - test: Containerized test runner (profile: test)
#
# Run tests:
#   docker-compose --profile test run --rm test
#   docker-compose --profile test run --rm test --suite security
#   TEST_COVERAGE=true docker-compose --profile test run --rm test
#
# =============================================================================

services:
  # ===========================================================================
  # AIOBS Visualization Dashboard (FastAPI)
  # ===========================================================================
  visualization:
    build:
      context: .
      dockerfile: Dockerfile.visualization
    container_name: aiobs-visualization
    ports:
      - "${VISUALIZATION_PORT:-8000}:8000"
    environment:
      - PORT=8000
      - HOST=0.0.0.0
      - BACKEND_URL=http://backend:3000
      - VICTORIA_METRICS_URL=http://victoriametrics:8428
      - OPENOBSERVE_URL=http://openobserve:5080
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE:-en}
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - aiobs-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.aiobs-viz.rule=Host(`aiobs.local`)"
      - "traefik.http.services.aiobs-viz.loadbalancer.server.port=8000"

  # ===========================================================================
  # AIOBS Backend Platform (TypeScript/Node.js)
  # ===========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: aiobs-backend
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - VICTORIA_METRICS_URL=http://victoriametrics:8428
      - OPENOBSERVE_URL=http://openobserve:5080
      - OPENOBSERVE_USER=${OPENOBSERVE_USER:-admin}
      - OPENOBSERVE_PASSWORD=${OPENOBSERVE_PASSWORD:-Complexpass#123}
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      victoriametrics:
        condition: service_healthy
      openobserve-healthcheck:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - aiobs-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # VictoriaMetrics - High-Performance Time-Series Database
  # For: Metrics, SLIs, Performance Data
  # ===========================================================================
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.96.0
    container_name: aiobs-victoriametrics
    ports:
      - "${VICTORIA_METRICS_PORT:-8428}:8428"
    volumes:
      - victoriametrics-data:/victoria-metrics-data
    command:
      - "--storageDataPath=/victoria-metrics-data"
      - "--httpListenAddr=:8428"
      - "--retentionPeriod=90d"
      - "--search.latencyOffset=0s"
      - "--search.maxUniqueTimeseries=300000"
    networks:
      - aiobs-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q -O /dev/null http://127.0.0.1:8428/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ===========================================================================
  # OpenObserve - Unified Logs, Traces, and Metrics
  # For: Audit Logs, Compliance Records, Traces
  # ===========================================================================
  openobserve:
    # Using latest stable version
    image: public.ecr.aws/zinclabs/openobserve:latest
    container_name: aiobs-openobserve
    ports:
      - "${OPENOBSERVE_PORT:-5080}:5080"
    environment:
      - ZO_ROOT_USER_EMAIL=${OPENOBSERVE_USER:-admin@aiobs.local}
      - ZO_ROOT_USER_PASSWORD=${OPENOBSERVE_PASSWORD:-Complexpass#123}
      - ZO_DATA_DIR=/data
      - ZO_HTTP_PORT=5080
      - ZO_TELEMETRY_ENABLED=false
    volumes:
      - openobserve-data:/data
    networks:
      - aiobs-network
    restart: unless-stopped
    # No healthcheck in container - use openobserve-healthcheck sidecar instead
    # OpenObserve minimal image doesn't include curl/wget/shell

  # Sidecar container to provide healthcheck for OpenObserve
  # This allows dependent services to wait for OpenObserve to be ready
  openobserve-healthcheck:
    image: busybox:stable
    container_name: aiobs-openobserve-healthcheck
    depends_on:
      - openobserve
    networks:
      - aiobs-network
    # Keep container running with a sleep loop
    command: ["sh", "-c", "while true; do sleep 3600; done"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://openobserve:5080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 60s

  # ===========================================================================
  # Redis - Caching and Real-time Pub/Sub
  # For: Session Cache, WebSocket Pub/Sub, Rate Limiting
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: aiobs-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - aiobs-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ===========================================================================
  # VMAgent - VictoriaMetrics Scraping Agent
  # Collects metrics from services and writes to VictoriaMetrics
  # ===========================================================================
  vmagent:
    image: victoriametrics/vmagent:v1.96.0
    container_name: aiobs-vmagent
    profiles:
      - monitoring
    ports:
      - "${VMAGENT_PORT:-8429}:8429"
    volumes:
      - ./docker/victoriametrics/vmagent.yml:/etc/vmagent/config.yml:ro
      - vmagent-data:/vmagentdata
    command:
      - "--promscrape.config=/etc/vmagent/config.yml"
      - "--remoteWrite.url=http://victoriametrics:8428/api/v1/write"
      - "--remoteWrite.tmpDataPath=/vmagentdata"
    depends_on:
      victoriametrics:
        condition: service_healthy
    networks:
      - aiobs-network
    restart: unless-stopped

  # ===========================================================================
  # Grafana (Optional) - Advanced Visualization
  # ===========================================================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: aiobs-grafana
    profiles:
      - monitoring
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - victoriametrics
    networks:
      - aiobs-network
    restart: unless-stopped

  # ===========================================================================
  # AIOBS Test Runner
  # Containerized test execution for CI/CD and local validation
  # ===========================================================================
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: aiobs-test
    profiles:
      - test
    environment:
      - TEST_SUITE=${TEST_SUITE:-all}
      - TEST_VERBOSE=${TEST_VERBOSE:-true}
      - TEST_COVERAGE=${TEST_COVERAGE:-false}
      - TEST_REPORT=${TEST_REPORT:-true}
      - TEST_PARALLEL=${TEST_PARALLEL:-false}
      - TEST_TIMEOUT=${TEST_TIMEOUT:-600}
    volumes:
      # Mount test reports directory for persistence
      - ./test_reports:/app/test_reports
      # Optional: mount tests for live changes during development
      # - ./tests:/app/tests:ro
    networks:
      # Use dedicated test network to avoid conflicts with main services
      # This prevents "network has active endpoints" errors when running
      # tests while other services are running
      - test-network
    # Test runner exits after completion
    restart: "no"

# =============================================================================
# Networks
# =============================================================================
networks:
  aiobs-network:
    driver: bridge
    # Note: No explicit subnet - Docker assigns automatically to avoid conflicts
  # Dedicated network for test runner to avoid conflicts with main services
  test-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  victoriametrics-data:
    driver: local
  openobserve-data:
    driver: local
  redis-data:
    driver: local
  vmagent-data:
    driver: local
  grafana-data:
    driver: local
