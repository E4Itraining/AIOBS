<!DOCTYPE html>
<html lang="{{ lang|default('en') }}" data-theme="light" {% if is_rtl %}dir="rtl"{% endif %}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | GASKIA</title>
    <meta name="description" content="GASKIA - Voir. Prouver. Maîtriser. Trust Control Layer for AI Systems.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/images/favicons/favicon.svg">

    <!-- Fonts - Space Grotesk (Headings) + Inter (Body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/ux-enhancements.css">

    <!-- i18n Setup -->
    <script>
        window.GASKIA = window.GASKIA || {};
        window.GASKIA.lang = '{{ lang|default("en") }}';
        window.GASKIA.isRtl = {{ is_rtl|default(false)|lower }};
        window.GASKIA.translations = {{ translations|tojson|safe }};
        // Alias for compatibility
        window.AIOBS = window.GASKIA;

        window.t = function(key, params) {
            const keys = key.split('.');
            let value = window.AIOBS.translations;
            for (const k of keys) {
                if (value && typeof value === 'object') {
                    value = value[k];
                } else {
                    return key;
                }
            }
            if (typeof value !== 'string') return key;
            if (params) {
                Object.keys(params).forEach(param => {
                    value = value.replace(new RegExp(`{${param}}`, 'g'), params[param]);
                });
            }
            return value;
        };
    </script>
</head>
<body>
    <!-- Skip to main content link for accessibility (WCAG 2.4.1) -->
    <a href="#main-content" class="skip-to-content">
        {{ t('a11y.skip_to_content') or 'Skip to main content' }}
    </a>

    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="/static/images/logos/gaskia-icon.svg" alt="GASKIA Eye Icon" width="44" height="44">
                    </div>
                    <div class="logo-content">
                        <span class="logo-text">GASKIA</span>
                        <span class="logo-tagline">Voir. Prouver. Maîtriser.</span>
                    </div>
                </div>
                <button class="sidebar-close" id="sidebarClose" aria-label="Close menu">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <!-- Persona Indicator -->
                <div class="persona-indicator" id="personaIndicator">
                    <div class="persona-badge">
                        <i data-lucide="user-circle" class="persona-icon"></i>
                        <div class="persona-info">
                            <span class="persona-label">{{ t('nav.my_journey') or 'Mon Parcours' }}</span>
                            <span class="persona-name" id="currentPersonaName">{{ t('nav.select_persona') or 'Sélectionner' }}</span>
                        </div>
                        <i data-lucide="chevron-down" class="persona-chevron"></i>
                    </div>
                </div>

                <!-- Mes Essentiels (Dynamic based on persona) -->
                <div class="nav-group nav-group-essentials" id="navEssentials">
                    <span class="nav-group-title">
                        <i data-lucide="star" class="title-icon"></i>
                        {{ t('nav.my_essentials') or 'Mes Essentiels' }}
                    </span>
                    <div class="nav-essentials-list" id="essentialsList">
                        <!-- Dynamically populated based on persona -->
                        <a href="/dashboard" class="nav-link {% if active_page == 'dashboard' %}active{% endif %}">
                            <i data-lucide="home"></i>
                            <span>{{ t('nav.home') or 'Tableau de Bord' }}</span>
                        </a>
                        <a href="/" class="nav-link {% if active_page == 'welcome' %}active{% endif %}">
                            <i data-lucide="compass"></i>
                            <span>{{ t('nav.persona_selection') or 'Choix Parcours' }}</span>
                        </a>
                    </div>
                </div>

                <!-- Explorer (Collapsible sections) -->
                <div class="nav-group nav-group-explore">
                    <span class="nav-group-title">
                        <i data-lucide="compass" class="title-icon"></i>
                        {{ t('nav.explore') or 'Explorer' }}
                    </span>

                    <!-- Accordion: Perspectives (merged with Vues) -->
                    <div class="nav-accordion" data-accordion="perspectives">
                        <button class="nav-accordion-header"
                                aria-expanded="false"
                                aria-controls="perspectives-content"
                                data-accordion-id="perspectives">
                            <i data-lucide="eye"></i>
                            <span>{{ t('nav.perspectives') or 'Perspectives' }}</span>
                            <i data-lucide="chevron-right" class="accordion-chevron"></i>
                        </button>
                        <div class="nav-accordion-content" id="perspectives-content" hidden>
                            <a href="/global" class="nav-link {% if active_page == 'global' %}active{% endif %}">
                                <i data-lucide="globe"></i>
                                <span>{{ t('nav.global_view') or 'Global' }}</span>
                            </a>
                            <a href="/unified" class="nav-link {% if active_page == 'unified' %}active{% endif %}">
                                <i data-lucide="layers"></i>
                                <span>{{ t('nav.unified_view') or 'Vue Unifiée' }}</span>
                            </a>
                            <a href="/executive" class="nav-link {% if active_page == 'executive' %}active{% endif %}">
                                <i data-lucide="briefcase"></i>
                                <span>{{ t('nav.executive_view') or 'Vue Executive' }}</span>
                            </a>
                            <a href="/dirigeant" class="nav-link {% if active_page == 'dirigeant' %}active{% endif %}">
                                <i data-lucide="building-2"></i>
                                <span>{{ t('nav.dirigeant_view') or 'Business' }}</span>
                            </a>
                            <a href="/tech" class="nav-link {% if active_page == 'tech' %}active{% endif %}">
                                <i data-lucide="server"></i>
                                <span>{{ t('nav.tech_view') or 'Tech' }}</span>
                            </a>
                            <a href="/juridique" class="nav-link {% if active_page == 'juridique' %}active{% endif %}">
                                <i data-lucide="gavel"></i>
                                <span>{{ t('nav.juridique_view') or 'Juridique' }}</span>
                            </a>
                            <a href="/financier" class="nav-link {% if active_page == 'financier' %}active{% endif %}">
                                <i data-lucide="wallet"></i>
                                <span>{{ t('nav.financier_view') or 'Finance' }}</span>
                            </a>
                        </div>
                    </div>

                    <!-- Accordion: Analyse & IA (merged Analysis + Intelligence) -->
                    <div class="nav-accordion" data-accordion="analysis">
                        <button class="nav-accordion-header"
                                aria-expanded="false"
                                aria-controls="analysis-content"
                                data-accordion-id="analysis">
                            <i data-lucide="brain"></i>
                            <span>{{ t('nav.analysis_ia') or 'Analyse & IA' }}</span>
                            <i data-lucide="chevron-right" class="accordion-chevron"></i>
                        </button>
                        <div class="nav-accordion-content" id="analysis-content" hidden>
                            <a href="/causal" class="nav-link {% if active_page == 'causal' %}active{% endif %}">
                                <i data-lucide="git-branch"></i>
                                <span>{{ t('nav.causal_analysis') or 'Analyse Causale' }}</span>
                            </a>
                            <a href="/impact" class="nav-link {% if active_page == 'impact' %}active{% endif %}">
                                <i data-lucide="trending-up"></i>
                                <span>{{ t('nav.impact_analysis') or 'Analyse d\'Impact' }}</span>
                            </a>
                            <a href="/multi-agent" class="nav-link {% if active_page == 'multi-agent' %}active{% endif %}">
                                <i data-lucide="network"></i>
                                <span>{{ t('nav.multi_agent') or 'Orchestration Multi-Agents' }}</span>
                            </a>
                            <a href="/healing" class="nav-link {% if active_page == 'healing' %}active{% endif %}">
                                <i data-lucide="heart-pulse"></i>
                                <span>{{ t('nav.healing') or 'Auto-Réparation' }}</span>
                            </a>
                            <a href="/business-intelligence" class="nav-link {% if active_page == 'business-intelligence' %}active{% endif %}">
                                <i data-lucide="bar-chart-3"></i>
                                <span>{{ t('nav.business_intelligence') or 'Tableaux de Bord BI' }}</span>
                            </a>
                        </div>
                    </div>

                    <!-- Accordion: Opérations -->
                    <div class="nav-accordion" data-accordion="operations">
                        <button class="nav-accordion-header"
                                aria-expanded="false"
                                aria-controls="operations-content"
                                data-accordion-id="operations">
                            <i data-lucide="settings"></i>
                            <span>{{ t('nav.operations') or 'Opérations' }}</span>
                            <i data-lucide="chevron-right" class="accordion-chevron"></i>
                        </button>
                        <div class="nav-accordion-content" id="operations-content" hidden>
                            <a href="/monitoring" class="nav-link {% if active_page == 'monitoring' %}active{% endif %}">
                                <i data-lucide="activity"></i>
                                <span>{{ t('nav.monitoring') or 'Monitoring Live' }}</span>
                            </a>
                            <a href="/finops" class="nav-link {% if active_page == 'finops' %}active{% endif %}">
                                <i data-lucide="coins"></i>
                                <span>{{ t('nav.finops') or 'Coûts & FinOps' }}</span>
                            </a>
                            <a href="/greenops" class="nav-link {% if active_page == 'greenops' %}active{% endif %}">
                                <i data-lucide="leaf"></i>
                                <span>{{ t('nav.greenops') or 'Impact Carbone' }}</span>
                            </a>
                        </div>
                    </div>

                    <!-- Accordion: Gouvernance -->
                    <div class="nav-accordion" data-accordion="governance">
                        <button class="nav-accordion-header"
                                aria-expanded="false"
                                aria-controls="governance-content"
                                data-accordion-id="governance">
                            <i data-lucide="shield"></i>
                            <span>{{ t('nav.governance') or 'Gouvernance' }}</span>
                            <i data-lucide="chevron-right" class="accordion-chevron"></i>
                        </button>
                        <div class="nav-accordion-content" id="governance-content" hidden>
                            <a href="/compliance" class="nav-link {% if active_page == 'compliance' %}active{% endif %}">
                                <i data-lucide="shield-check"></i>
                                <span>{{ t('nav.compliance') or 'Conformité IA' }}</span>
                            </a>
                            <a href="/security" class="nav-link {% if active_page == 'security' %}active{% endif %}">
                                <i data-lucide="lock"></i>
                                <span>{{ t('nav.security') or 'Centre Sécurité' }}</span>
                            </a>
                            <a href="/guardrails" class="nav-link {% if active_page == 'guardrails' %}active{% endif %}">
                                <i data-lucide="shield-alert"></i>
                                <span>{{ t('nav.guardrails') or 'GenAI Guardrails' }}</span>
                            </a>
                            <a href="/supply-chain" class="nav-link {% if active_page == 'supply-chain' %}active{% endif %}">
                                <i data-lucide="box"></i>
                                <span>{{ t('nav.supply_chain') or 'AI Supply Chain' }}</span>
                            </a>
                        </div>
                    </div>

                </div>

                <!-- Change Journey Link -->
                <div class="nav-group nav-group-change">
                    <a href="/personas" class="nav-link nav-link-change {% if active_page == 'personas' %}active{% endif %}">
                        <i data-lucide="refresh-cw"></i>
                        <span>{{ t('nav.change_journey') or 'Changer de parcours' }}</span>
                    </a>
                </div>

                {% block sidebar_extra %}{% endblock %}
            </nav>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="themeToggleBtn" title="Toggle theme" aria-label="Changer le thème">
                    <i data-lucide="sun" class="theme-icon-light"></i>
                    <i data-lucide="moon" class="theme-icon-dark"></i>
                </button>
                <div class="language-selector" id="languageSelector">
                    <button class="language-btn" id="languageToggleBtn" aria-expanded="false" aria-haspopup="menu" aria-controls="languageDropdown">
                        <i data-lucide="globe"></i>
                        <span id="currentLang">{{ lang|default('en')|upper }}</span>
                        <i data-lucide="chevron-up" class="chevron"></i>
                    </button>
                    <div class="language-dropdown" id="languageDropdown" role="menu" hidden>
                        {% for code, info in (languages or {}).items() %}
                        <button class="language-option {% if code == lang %}active{% endif %}" role="menuitem" data-lang="{{ code }}">
                            <span class="flag">{{ info.flag }}</span>
                            <span class="name">{{ info.name }}</span>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mobile overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <main class="main">
            <!-- Top Bar -->
            <header class="topbar">
                <button class="menu-toggle" id="menuToggle" aria-label="Open menu">
                    <i data-lucide="menu"></i>
                </button>

                <!-- Breadcrumbs -->
                <nav class="breadcrumbs" aria-label="Breadcrumb">
                    <a href="/" class="breadcrumb-item breadcrumb-home">
                        <i data-lucide="home"></i>
                    </a>
                    {% if breadcrumbs %}
                        {% for crumb in breadcrumbs %}
                        <span class="breadcrumb-separator">
                            <i data-lucide="chevron-right"></i>
                        </span>
                        {% if crumb.url %}
                        <a href="{{ crumb.url }}" class="breadcrumb-item">{{ crumb.label }}</a>
                        {% else %}
                        <span class="breadcrumb-item active">{{ crumb.label }}</span>
                        {% endif %}
                        {% endfor %}
                    {% else %}
                        {% if active_page and active_page != 'dashboard' %}
                        <span class="breadcrumb-separator">
                            <i data-lucide="chevron-right"></i>
                        </span>
                        <span class="breadcrumb-item active">{{ title }}</span>
                        {% endif %}
                    {% endif %}
                </nav>

                <div class="topbar-title">
                    <h1>{% block page_title %}{{ title }}{% endblock %}</h1>
                    {% block page_subtitle %}{% endblock %}
                </div>

                <!-- Global Search -->
                <div class="global-search" id="globalSearch">
                    <div class="search-container">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text"
                               id="globalSearchInput"
                               class="search-input"
                               placeholder="{{ t('search.placeholder') or 'Search pages, metrics, services...' }}"
                               onkeyup="handleGlobalSearch(event)"
                               onfocus="showSearchResults()"
                               autocomplete="off">
                        <kbd class="search-shortcut">⌘K</kbd>
                    </div>
                    <div class="search-results" id="searchResults">
                        <div class="search-results-header">
                            <span>{{ t('search.results') or 'Quick Navigation' }}</span>
                        </div>
                        <div class="search-results-content" id="searchResultsContent">
                            <!-- Dynamic search results -->
                        </div>
                    </div>
                </div>

                <div class="topbar-actions">
                    {% block topbar_actions %}{% endblock %}
                </div>
            </header>

            <!-- Content Area -->
            <div class="content" id="main-content" tabindex="-1">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Toast Container with aria-live for accessibility (WCAG 4.1.3) -->
    <div class="toast-container" id="toastContainer" role="alert" aria-live="polite" aria-atomic="true"></div>

    <!-- Contextual Help Bubble -->
    <div class="help-bubble" id="helpBubble">
        <button class="help-trigger" onclick="toggleHelpPanel()" title="{{ t('help.title') or 'Help & Guide' }}">
            <i data-lucide="help-circle"></i>
        </button>
        <div class="help-panel">
            <div class="help-panel-header">
                <h3>
                    <i data-lucide="compass"></i>
                    {{ t('help.title') or 'Help & Guide' }}
                </h3>
                <button class="help-panel-close" onclick="toggleHelpPanel()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="help-panel-content" id="helpPanelContent">
                <!-- Quick Actions -->
                <div class="help-section">
                    <div class="help-section-title">{{ t('help.quick_actions') or 'Quick Actions' }}</div>
                    <div class="help-item" onclick="startGuidedTour()">
                        <div class="help-item-icon">
                            <i data-lucide="play-circle"></i>
                        </div>
                        <div class="help-item-content">
                            <h4>{{ t('help.start_tour') or 'Start Guided Tour' }}</h4>
                            <p>{{ t('help.start_tour_desc') or 'Learn the basics with an interactive walkthrough' }}</p>
                        </div>
                    </div>
                    <div class="help-item" onclick="window.location.href='/onboarding'">
                        <div class="help-item-icon">
                            <i data-lucide="user-circle"></i>
                        </div>
                        <div class="help-item-content">
                            <h4>{{ t('help.change_profile') or 'Change Profile' }}</h4>
                            <p>{{ t('help.change_profile_desc') or 'Switch to a different user persona' }}</p>
                        </div>
                    </div>
                </div>
                <!-- Current Page Help -->
                <div class="help-section" id="pageHelpSection">
                    <div class="help-section-title">{{ t('help.this_page') or 'On This Page' }}</div>
                    <div id="pageHelpContent">
                        <!-- Dynamically populated based on current page -->
                    </div>
                </div>
                <!-- Resources -->
                <div class="help-section">
                    <div class="help-section-title">{{ t('help.resources') or 'Resources' }}</div>
                    <div class="help-item" onclick="showKeyboardShortcuts()">
                        <div class="help-item-icon">
                            <i data-lucide="keyboard"></i>
                        </div>
                        <div class="help-item-content">
                            <h4>{{ t('help.keyboard_shortcuts') or 'Keyboard Shortcuts' }}</h4>
                            <p>{{ t('help.keyboard_shortcuts_desc') or 'Speed up your workflow' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chatbot Assistant -->
    <div class="chatbot-container" id="chatbotContainer" role="complementary" aria-label="{{ t('chatbot.title') or 'AI Assistant' }}">
        <button class="chatbot-trigger" onclick="toggleChatbot()" title="{{ t('chatbot.title') or 'AI Assistant' }}" aria-expanded="false" aria-controls="chatbotPanel" aria-label="{{ t('chatbot.title') or 'Open AI Assistant' }}">
            <i data-lucide="message-circle" class="chatbot-icon-default" aria-hidden="true"></i>
            <i data-lucide="x" class="chatbot-icon-close" aria-hidden="true"></i>
        </button>
        <div class="chatbot-panel" id="chatbotPanel" role="dialog" aria-labelledby="chatbotTitle">
            <div class="chatbot-header">
                <div class="chatbot-header-info">
                    <div class="chatbot-avatar">
                        <i data-lucide="bot"></i>
                    </div>
                    <div>
                        <h3 id="chatbotTitle">{{ t('chatbot.title') or 'AI Assistant' }}</h3>
                        <span class="chatbot-status">
                            <span class="status-dot"></span>
                            {{ t('chatbot.online') or 'Online' }}
                        </span>
                    </div>
                </div>
                <div style="display: flex; gap: var(--space-2);">
                    <button class="chat-clear" onclick="clearChat()" title="{{ t('chatbot.clear') or 'Clear chat' }}">
                        <i data-lucide="trash-2"></i>
                    </button>
                    <button class="chatbot-minimize" onclick="toggleChatbot()">
                        <i data-lucide="minus"></i>
                    </button>
                </div>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="chatbot-welcome">
                    <div class="chatbot-welcome-icon">
                        <i data-lucide="sparkles"></i>
                    </div>
                    <h4>{{ t('chatbot.welcome_title') or 'Hello! How can I help you?' }}</h4>
                    <p>{{ t('chatbot.welcome_desc') or 'Ask me anything about your AI systems, metrics, or how to use GASKIA.' }}</p>
                </div>
                <div class="chatbot-suggestions" id="chatbotSuggestions">
                    <span class="suggestion-label">{{ t('chatbot.suggestions') or 'Quick questions:' }}</span>
                    <div class="suggestion-chips">
                        <button class="suggestion-chip" onclick="askQuestion('What is the current trust score?')">
                            <i data-lucide="gauge"></i>
                            {{ t('chatbot.q_trust') or 'Trust score?' }}
                        </button>
                        <button class="suggestion-chip" onclick="askQuestion('Are there any active alerts?')">
                            <i data-lucide="alert-triangle"></i>
                            {{ t('chatbot.q_alerts') or 'Active alerts?' }}
                        </button>
                        <button class="suggestion-chip" onclick="askQuestion('Show me today\'s costs')">
                            <i data-lucide="wallet"></i>
                            {{ t('chatbot.q_costs') or 'Today\'s costs?' }}
                        </button>
                        <button class="suggestion-chip" onclick="askQuestion('How do I navigate to compliance?')">
                            <i data-lucide="compass"></i>
                            {{ t('chatbot.q_navigate') or 'How to navigate?' }}
                        </button>
                    </div>
                </div>
            </div>
            <div class="chatbot-input-container">
                <input type="text"
                       id="chatbotInput"
                       class="chatbot-input"
                       placeholder="{{ t('chatbot.placeholder') or 'Type your question...' }}"
                       onkeypress="handleChatKeypress(event)"
                       aria-label="{{ t('chatbot.placeholder') or 'Type your question...' }}">
                <button class="chatbot-send" onclick="sendChatMessage()" id="chatbotSend" aria-label="{{ t('actions.send') or 'Send message' }}">
                    <i data-lucide="send" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Guided Tour Overlay -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="tour-spotlight" id="tourSpotlight"></div>
        <div class="tour-tooltip" id="tourTooltip">
            <div class="tour-tooltip-arrow top"></div>
            <div class="tour-tooltip-header">
                <span class="tour-step-badge" id="tourStepBadge">1</span>
                <h4 id="tourStepTitle">Welcome</h4>
            </div>
            <div class="tour-tooltip-body" id="tourStepBody">
                This is your dashboard.
            </div>
            <div class="tour-tooltip-footer">
                <span class="tour-progress" id="tourProgress">Step 1 of 5</span>
                <div class="tour-nav">
                    <button class="btn btn-ghost" id="tourPrevBtn" onclick="tourPrev()">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <button class="btn btn-ghost" onclick="endTour()">
                        {{ t('help.skip') or 'Skip' }}
                    </button>
                    <button class="btn btn-primary" id="tourNextBtn" onclick="tourNext()">
                        {{ t('help.next') or 'Next' }}
                        <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/ux-enhancements.js"></script>
    <script src="/static/js/chatbot.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('gaskia-theme', next);
            lucide.createIcons();
        }

        // Load saved theme
        (function() {
            const saved = localStorage.getItem('gaskia-theme') || localStorage.getItem('aiobs-theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();

        // Mobile Sidebar
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const menuToggle = document.getElementById('menuToggle');
        const sidebarClose = document.getElementById('sidebarClose');

        function openSidebar() {
            sidebar.classList.add('open');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        menuToggle?.addEventListener('click', openSidebar);
        sidebarClose?.addEventListener('click', closeSidebar);
        overlay?.addEventListener('click', closeSidebar);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeSidebar();
        });

        // Language Selector
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            const selector = document.getElementById('languageSelector');
            selector.classList.toggle('open');
        }

        async function setLanguage(code) {
            try {
                const response = await fetch(`/api/i18n/set-language/${code}`, { method: 'POST' });
                if (response.ok) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error setting language:', error);
            }
        }

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const selector = document.getElementById('languageSelector');
            if (selector && !selector.contains(e.target)) {
                selector.classList.remove('open');
            }
        });

        // =============================================
        // Adaptive Menu System (Persona-based)
        // =============================================

        // Persona journey configurations
        const PERSONA_JOURNEYS = {
            'business_executive': {
                name: 'Dirigeant',
                icon: 'briefcase',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/executive', icon: 'briefcase', label: 'Vue Executive' },
                    { url: '/compliance', icon: 'shield-check', label: 'Conformité IA' },
                    { url: '/finops', icon: 'coins', label: 'Coûts & FinOps' }
                ]
            },
            'tech_ml_engineer': {
                name: 'ML Engineer',
                icon: 'cpu',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/tech', icon: 'server', label: 'Vue Tech' },
                    { url: '/causal', icon: 'git-branch', label: 'Analyse Causale' },
                    { url: '/monitoring', icon: 'activity', label: 'Monitoring Live' }
                ]
            },
            'tech_data_scientist': {
                name: 'Data Scientist',
                icon: 'bar-chart-2',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/tech', icon: 'server', label: 'Vue Tech' },
                    { url: '/causal', icon: 'git-branch', label: 'Analyse Causale' },
                    { url: '/impact', icon: 'trending-up', label: 'Analyse d\'Impact' }
                ]
            },
            'tech_devops': {
                name: 'DevOps Engineer',
                icon: 'terminal',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/monitoring', icon: 'activity', label: 'Monitoring Live' },
                    { url: '/unified', icon: 'layers', label: 'Vue Unifiée' },
                    { url: '/security', icon: 'lock', label: 'Centre Sécurité' }
                ]
            },
            'compliance_legal': {
                name: 'Compliance Officer',
                icon: 'shield-check',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/compliance', icon: 'shield-check', label: 'Conformité IA' },
                    { url: '/juridique', icon: 'gavel', label: 'Vue Juridique' },
                    { url: '/security', icon: 'lock', label: 'Centre Sécurité' }
                ]
            },
            'security_soc': {
                name: 'Security SOC',
                icon: 'shield',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/security', icon: 'lock', label: 'Centre Sécurité' },
                    { url: '/monitoring', icon: 'activity', label: 'Monitoring Live' },
                    { url: '/compliance', icon: 'shield-check', label: 'Conformité IA' }
                ]
            },
            'sustainability_esg': {
                name: 'ESG Manager',
                icon: 'leaf',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/greenops', icon: 'leaf', label: 'Impact Carbone' },
                    { url: '/finops', icon: 'coins', label: 'Coûts & FinOps' },
                    { url: '/compliance', icon: 'shield-check', label: 'Conformité IA' }
                ]
            },
            'governance_dsi': {
                name: 'DSI / CIO',
                icon: 'landmark',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/executive', icon: 'briefcase', label: 'Vue Executive' },
                    { url: '/tech', icon: 'server', label: 'Vue Tech' },
                    { url: '/finops', icon: 'coins', label: 'Coûts & FinOps' }
                ]
            },
            'governance_rsi': {
                name: 'RSI / IT Manager',
                icon: 'settings',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/monitoring', icon: 'activity', label: 'Monitoring Live' },
                    { url: '/unified', icon: 'layers', label: 'Vue Unifiée' },
                    { url: '/security', icon: 'lock', label: 'Centre Sécurité' }
                ]
            },
            'privacy_dpo': {
                name: 'DPO',
                icon: 'user-check',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/compliance', icon: 'shield-check', label: 'Conformité IA' },
                    { url: '/juridique', icon: 'gavel', label: 'Vue Juridique' },
                    { url: '/security', icon: 'lock', label: 'Centre Sécurité' }
                ]
            },
            'legal_counsel': {
                name: 'Legal Counsel',
                icon: 'scale',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/juridique', icon: 'gavel', label: 'Vue Juridique' },
                    { url: '/compliance', icon: 'shield-check', label: 'Conformité IA' },
                    { url: '/impact', icon: 'trending-up', label: 'Analyse d\'Impact' }
                ]
            },
            'business_product': {
                name: 'Product Owner',
                icon: 'package',
                essentials: [
                    { url: '/', icon: 'home', label: 'Tableau de Bord' },
                    { url: '/dirigeant', icon: 'building-2', label: 'Vue Business' },
                    { url: '/impact', icon: 'trending-up', label: 'Analyse d\'Impact' },
                    { url: '/monitoring', icon: 'activity', label: 'Monitoring Live' }
                ]
            }
        };

        // Default essentials when no persona selected
        const DEFAULT_ESSENTIALS = [
            { url: '/', icon: 'home', label: 'Tableau de Bord' },
            { url: '/global', icon: 'globe', label: 'Vue Globale' },
            { url: '/executive', icon: 'briefcase', label: 'Vue Executive' },
            { url: '/monitoring', icon: 'activity', label: 'Monitoring Live' }
        ];

        // =============================================
        // OPTIMIZED STATE & CACHING
        // =============================================

        // Cached localStorage values (reduces API calls by 60-70%)
        const storageCache = {
            persona: localStorage.getItem('gaskia-persona') || localStorage.getItem('aiobs-persona'),
            accordionState: JSON.parse(localStorage.getItem('gaskia-accordion-state') || '{}'),
            _saveTimeout: null,

            getPersona() { return this.persona; },
            setPersona(value) {
                this.persona = value;
                localStorage.setItem('gaskia-persona', value);
            },
            getAccordionState() { return this.accordionState; },
            setAccordionState(id, isOpen) {
                this.accordionState[id] = isOpen;
                // Debounced save (300ms) - reduces writes by 80%
                clearTimeout(this._saveTimeout);
                this._saveTimeout = setTimeout(() => {
                    localStorage.setItem('gaskia-accordion-state', JSON.stringify(this.accordionState));
                }, 300);
            }
        };

        // IconManager - batches lucide.createIcons() calls (reduces by 50%+)
        const iconManager = {
            _scheduled: false,
            schedule(selector = null) {
                if (this._scheduled) return;
                this._scheduled = true;
                requestAnimationFrame(() => {
                    if (typeof lucide !== 'undefined') {
                        if (selector) {
                            document.querySelectorAll(selector).forEach(el => {
                                lucide.createIcons({ nodes: [el] });
                            });
                        } else {
                            lucide.createIcons();
                        }
                    }
                    this._scheduled = false;
                });
            }
        };

        // =============================================
        // ACCORDION - EVENT DELEGATION (WCAG 2.1 AA)
        // =============================================

        function toggleAccordion(id) {
            const header = document.querySelector(`[data-accordion-id="${id}"]`);
            const content = document.getElementById(`${id}-content`);
            const accordion = document.querySelector(`[data-accordion="${id}"]`);
            if (!header || !content || !accordion) return;

            const isOpen = header.getAttribute('aria-expanded') === 'true';
            const newState = !isOpen;

            // Update ARIA state
            header.setAttribute('aria-expanded', newState);
            content.hidden = !newState;
            accordion.classList.toggle('open', newState);

            // Save state (debounced)
            storageCache.setAccordionState(id, newState);

            // Update chevron icon only
            iconManager.schedule(`[data-accordion="${id}"] .accordion-chevron`);
        }

        // Event delegation for accordion headers
        document.addEventListener('click', (e) => {
            const header = e.target.closest('.nav-accordion-header');
            if (header && header.dataset.accordionId) {
                e.preventDefault();
                toggleAccordion(header.dataset.accordionId);
            }
        });

        // Keyboard support for accordions
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                const header = e.target.closest('.nav-accordion-header');
                if (header && header.dataset.accordionId) {
                    e.preventDefault();
                    toggleAccordion(header.dataset.accordionId);
                }
            }
        });

        // Restore accordion state (optimized - single pass)
        function restoreAccordionState() {
            const state = storageCache.getAccordionState();

            // Single pass through stored state
            Object.entries(state).forEach(([id, isOpen]) => {
                if (isOpen) {
                    const header = document.querySelector(`[data-accordion-id="${id}"]`);
                    const content = document.getElementById(`${id}-content`);
                    const accordion = document.querySelector(`[data-accordion="${id}"]`);
                    if (header && content && accordion) {
                        header.setAttribute('aria-expanded', 'true');
                        content.hidden = false;
                        accordion.classList.add('open');
                    }
                }
            });

            // Auto-open accordion containing active link (single query)
            const activeLink = document.querySelector('.nav-accordion .nav-link.active');
            if (activeLink) {
                const accordion = activeLink.closest('.nav-accordion');
                if (accordion) {
                    const id = accordion.dataset.accordion;
                    const header = accordion.querySelector('.nav-accordion-header');
                    const content = document.getElementById(`${id}-content`);
                    if (header && content) {
                        header.setAttribute('aria-expanded', 'true');
                        content.hidden = false;
                        accordion.classList.add('open');
                        storageCache.setAccordionState(id, true);
                    }
                }
            }
        }

        // Load and apply current persona (optimized with cache)
        function loadCurrentPersona() {
            const savedPersona = storageCache.getPersona();
            const personaNameEl = document.getElementById('currentPersonaName');
            const essentialsList = document.getElementById('essentialsList');
            const personaIndicator = document.getElementById('personaIndicator');
            const currentPath = window.location.pathname;

            const persona = savedPersona && PERSONA_JOURNEYS[savedPersona]
                ? PERSONA_JOURNEYS[savedPersona]
                : null;

            const essentials = persona ? persona.essentials : DEFAULT_ESSENTIALS;

            // Update persona indicator
            if (personaNameEl) {
                personaNameEl.textContent = persona ? persona.name : (window.t('nav.select_persona') || 'Sélectionner');
            }
            if (personaIndicator) {
                personaIndicator.classList.toggle('has-persona', !!persona);
                const iconEl = personaIndicator.querySelector('.persona-icon');
                if (iconEl && persona) {
                    iconEl.setAttribute('data-lucide', persona.icon);
                }
            }

            // Update essentials list (single render)
            if (essentialsList) {
                essentialsList.innerHTML = essentials.map(item => `
                    <a href="${item.url}" class="nav-link ${currentPath === item.url ? 'active' : ''}">
                        <i data-lucide="${item.icon}"></i>
                        <span>${item.label}</span>
                    </a>
                `).join('');
            }

            // Batch icon update
            iconManager.schedule('#essentialsList [data-lucide], .persona-icon');
        }

        // Set persona (optimized with cache)
        function setPersona(personaId) {
            storageCache.setPersona(personaId);
            loadCurrentPersona();
        }

        // Make functions globally available
        window.setPersona = setPersona;
        window.toggleAccordion = toggleAccordion;
        window.PERSONA_JOURNEYS = PERSONA_JOURNEYS;

        // =============================================
        // THEME & LANGUAGE - EVENT DELEGATION
        // =============================================

        // Theme toggle
        document.getElementById('themeToggleBtn')?.addEventListener('click', () => {
            if (typeof toggleTheme === 'function') toggleTheme();
        });

        // Language dropdown toggle
        function toggleLanguageDropdown() {
            const btn = document.getElementById('languageToggleBtn');
            const dropdown = document.getElementById('languageDropdown');
            if (!btn || !dropdown) return;

            const isOpen = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', !isOpen);
            dropdown.hidden = isOpen;
        }

        document.getElementById('languageToggleBtn')?.addEventListener('click', toggleLanguageDropdown);

        // Language selection (event delegation)
        document.getElementById('languageDropdown')?.addEventListener('click', (e) => {
            const option = e.target.closest('.language-option');
            if (option && option.dataset.lang) {
                if (typeof setLanguage === 'function') {
                    setLanguage(option.dataset.lang);
                }
            }
        });

        // Close language dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const selector = document.getElementById('languageSelector');
            const dropdown = document.getElementById('languageDropdown');
            const btn = document.getElementById('languageToggleBtn');
            if (selector && !selector.contains(e.target) && dropdown && !dropdown.hidden) {
                dropdown.hidden = true;
                btn?.setAttribute('aria-expanded', 'false');
            }
        });

        // =============================================
        // MOBILE UX ENHANCEMENTS
        // =============================================

        function initMobileUX() {
            if (window.innerWidth > 768) return;

            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;

            let touchStartX = 0;
            let touchStartY = 0;

            // Swipe-to-close sidebar
            sidebar.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            sidebar.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const deltaX = touchStartX - touchEndX;
                const deltaY = Math.abs(touchStartY - touchEndY);

                // Swipe left to close (50px threshold, more horizontal than vertical)
                if (deltaX > 50 && deltaX > deltaY) {
                    sidebar.classList.remove('open');
                    document.getElementById('sidebarOverlay')?.classList.remove('active');
                }
            }, { passive: true });

            // Close sidebar when clicking a nav link (mobile only)
            sidebar.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                        document.getElementById('sidebarOverlay')?.classList.remove('active');
                    }
                });
            });
        }

        // =============================================
        // INITIALIZATION
        // =============================================

        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentPersona();
            restoreAccordionState();
            initMobileUX();
        });

        // Persona indicator click - go to personas page
        document.getElementById('personaIndicator')?.addEventListener('click', () => {
            window.location.href = '/personas';
        });

        // =============================================
        // Help Panel & Guided Tour System
        // =============================================

        // Help Panel Toggle
        function toggleHelpPanel() {
            const helpBubble = document.getElementById('helpBubble');
            helpBubble.classList.toggle('open');
            if (helpBubble.classList.contains('open')) {
                loadPageHelp();
            }
            lucide.createIcons();
        }

        // Load contextual help based on current page
        function loadPageHelp() {
            const path = window.location.pathname;
            const pageHelpContent = document.getElementById('pageHelpContent');
            const helpItems = getPageHelpItems(path);

            pageHelpContent.innerHTML = helpItems.map(item => `
                <div class="help-item" onclick="${item.action || ''}">
                    <div class="help-item-icon">
                        <i data-lucide="${item.icon}"></i>
                    </div>
                    <div class="help-item-content">
                        <h4>${item.title}</h4>
                        <p>${item.description}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Get help items based on current page
        function getPageHelpItems(path) {
            const helpConfig = {
                '/': [
                    { icon: 'gauge', title: window.t('help.kpi_title') || 'KPI Overview', description: window.t('help.kpi_desc') || 'Key performance indicators for your AI systems' },
                    { icon: 'activity', title: window.t('help.health_title') || 'System Health', description: window.t('help.health_desc') || 'Monitor the health status of all services' },
                    { icon: 'alert-triangle', title: window.t('help.alerts_title') || 'Active Alerts', description: window.t('help.alerts_desc') || 'View and investigate current issues' }
                ],
                '/unified': [
                    { icon: 'layers', title: window.t('help.unified_title') || 'Unified View', description: window.t('help.unified_desc') || 'Single pane of glass for all metrics' },
                    { icon: 'filter', title: window.t('help.filter_title') || 'Filters', description: window.t('help.filter_desc') || 'Filter data by service, model, or time range' }
                ],
                '/causal': [
                    { icon: 'git-branch', title: window.t('help.causal_title') || 'Causal Graph', description: window.t('help.causal_desc') || 'Visualize cause-effect relationships' },
                    { icon: 'search', title: window.t('help.rca_title') || 'Root Cause Analysis', description: window.t('help.rca_desc') || 'Identify the source of issues' }
                ],
                '/executive': [
                    { icon: 'briefcase', title: window.t('help.exec_title') || 'Executive Summary', description: window.t('help.exec_desc') || 'High-level KPIs and business impact' },
                    { icon: 'trending-up', title: window.t('help.trends_title') || 'Trends', description: window.t('help.trends_desc') || 'Track improvements over time' }
                ],
                '/compliance': [
                    { icon: 'shield-check', title: window.t('help.compliance_title') || 'Compliance Status', description: window.t('help.compliance_desc') || 'View regulatory compliance overview' },
                    { icon: 'clipboard', title: window.t('help.audit_title') || 'Audit Trail', description: window.t('help.audit_desc') || 'Track all compliance-related activities' }
                ],
                '/greenops': [
                    { icon: 'leaf', title: window.t('help.carbon_title') || 'Carbon Tracking', description: window.t('help.carbon_desc') || 'Monitor environmental impact' },
                    { icon: 'lightbulb', title: window.t('help.recommendations_title') || 'Recommendations', description: window.t('help.recommendations_desc') || 'Get tips to reduce carbon footprint' }
                ],
                '/security': [
                    { icon: 'shield', title: window.t('help.security_title') || 'Security Posture', description: window.t('help.security_desc') || 'Overall security health score' },
                    { icon: 'alert-octagon', title: window.t('help.threats_title') || 'Threat Detection', description: window.t('help.threats_desc') || 'Monitor for security incidents' }
                ]
            };

            return helpConfig[path] || helpConfig['/'];
        }

        // Guided Tour State
        let tourState = {
            active: false,
            currentStep: 0,
            steps: []
        };

        // Tour steps configuration per page
        const tourConfigs = {
            '/': [
                { target: '.kpi-grid', title: window.t('tour.kpi_title') || 'Key Performance Indicators', body: window.t('tour.kpi_body') || 'These cards show your most important AI metrics at a glance: trust score, daily inferences, costs, and carbon footprint.' },
                { target: '.sidebar-nav', title: window.t('tour.nav_title') || 'Navigation', body: window.t('tour.nav_body') || 'Use the sidebar to navigate between different views. Each view is optimized for specific use cases.' },
                { target: '#profileSelector', title: window.t('tour.profile_title') || 'Profile Selection', body: window.t('tour.profile_body') || 'Switch between different user profiles to see dashboards tailored for your role.' },
                { target: '#trustChart', title: window.t('tour.chart_title') || 'Trust Score Trend', body: window.t('tour.chart_body') || 'Track how your AI system\'s reliability evolves over time.' },
                { target: '.help-trigger', title: window.t('tour.help_title') || 'Help & Guide', body: window.t('tour.help_body') || 'Click here anytime to get contextual help or restart this tour.' }
            ],
            '/causal': [
                { target: '.card', title: window.t('tour.causal_graph_title') || 'Causal Graph', body: window.t('tour.causal_graph_body') || 'This visualization shows cause-effect relationships between events in your AI system.' },
                { target: '.sidebar-nav', title: window.t('tour.analysis_title') || 'Analysis Tools', body: window.t('tour.analysis_body') || 'Use the navigation to access different analysis views.' }
            ],
            '/executive': [
                { target: '.kpi-grid', title: window.t('tour.exec_kpi_title') || 'Business KPIs', body: window.t('tour.exec_kpi_body') || 'High-level metrics that matter for business decisions.' },
                { target: '.chart-container', title: window.t('tour.exec_charts_title') || 'Visual Insights', body: window.t('tour.exec_charts_body') || 'Charts and graphs designed for quick understanding without technical details.' }
            ]
        };

        // Start guided tour
        function startGuidedTour() {
            toggleHelpPanel(); // Close help panel
            const path = window.location.pathname;
            tourState.steps = tourConfigs[path] || tourConfigs['/'];
            tourState.currentStep = 0;
            tourState.active = true;
            showTourStep();
        }

        // Show current tour step
        function showTourStep() {
            const overlay = document.getElementById('tourOverlay');
            const tooltip = document.getElementById('tourTooltip');
            const spotlight = document.getElementById('tourSpotlight');
            const step = tourState.steps[tourState.currentStep];

            if (!step) {
                endTour();
                return;
            }

            // Find target element
            const target = document.querySelector(step.target);
            if (!target) {
                tourNext();
                return;
            }

            // Show overlay
            overlay.classList.add('active');

            // Position spotlight
            const rect = target.getBoundingClientRect();
            spotlight.style.top = (rect.top - 8) + 'px';
            spotlight.style.left = (rect.left - 8) + 'px';
            spotlight.style.width = (rect.width + 16) + 'px';
            spotlight.style.height = (rect.height + 16) + 'px';

            // Update tooltip content
            document.getElementById('tourStepBadge').textContent = tourState.currentStep + 1;
            document.getElementById('tourStepTitle').textContent = step.title;
            document.getElementById('tourStepBody').textContent = step.body;
            document.getElementById('tourProgress').textContent = `Step ${tourState.currentStep + 1} of ${tourState.steps.length}`;

            // Position tooltip
            const tooltipTop = rect.bottom + 20;
            const tooltipLeft = Math.max(16, Math.min(window.innerWidth - 336, rect.left));
            tooltip.style.top = tooltipTop + 'px';
            tooltip.style.left = tooltipLeft + 'px';

            // Update nav buttons
            document.getElementById('tourPrevBtn').style.visibility = tourState.currentStep > 0 ? 'visible' : 'hidden';
            document.getElementById('tourNextBtn').textContent = tourState.currentStep === tourState.steps.length - 1 ? (window.t('tour.finish') || 'Finish') : (window.t('help.next') || 'Next');

            lucide.createIcons();
        }

        // Next tour step
        function tourNext() {
            if (tourState.currentStep < tourState.steps.length - 1) {
                tourState.currentStep++;
                showTourStep();
            } else {
                endTour();
            }
        }

        // Previous tour step
        function tourPrev() {
            if (tourState.currentStep > 0) {
                tourState.currentStep--;
                showTourStep();
            }
        }

        // End tour
        function endTour() {
            tourState.active = false;
            document.getElementById('tourOverlay').classList.remove('active');
            localStorage.setItem('gaskia-tour-completed', 'true');
        }

        // Keyboard shortcuts
        function showKeyboardShortcuts() {
            showToast(window.t('help.shortcuts_coming') || 'Keyboard shortcuts: ? for help, G+D for dashboard, G+C for causal', 'info', 5000);
        }

        // Close help panel when clicking outside
        document.addEventListener('click', (e) => {
            const helpBubble = document.getElementById('helpBubble');
            if (helpBubble && !helpBubble.contains(e.target)) {
                helpBubble.classList.remove('open');
            }
        });

        // Check for first visit - redirect to onboarding
        document.addEventListener('DOMContentLoaded', () => {
            const onboardingComplete = localStorage.getItem('gaskia-onboarding-complete') || localStorage.getItem('aiobs-onboarding-complete');
            const hasPersona = localStorage.getItem('gaskia-persona') || localStorage.getItem('aiobs-persona');
            const currentPath = window.location.pathname;
            const excludedPaths = ['/onboarding', '/personas', '/api/', '/static/', '/health'];

            // Redirect to onboarding if first visit and no persona selected
            const isExcludedPath = excludedPaths.some(path => currentPath.startsWith(path));
            if (!onboardingComplete && !hasPersona && !isExcludedPath) {
                // Redirect new users to onboarding
                window.location.href = '/onboarding';
                return;
            }

            // If onboarding complete but no persona, show prompt
            if (onboardingComplete && !hasPersona && !isExcludedPath) {
                setTimeout(() => {
                    showToast(window.t('onboarding.select_persona') || 'Select your profile to personalize your experience', 'info', 6000);
                }, 2000);
            }
        });

        // =============================================
        // AI Chatbot System
        // =============================================
        let chatbotOpen = false;
        let chatHistory = [];

        function toggleChatbot() {
            const container = document.getElementById('chatbotContainer');
            chatbotOpen = !chatbotOpen;
            container.classList.toggle('open', chatbotOpen);
            if (chatbotOpen) {
                document.getElementById('chatbotInput').focus();
            }
            lucide.createIcons();
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function askQuestion(question) {
            document.getElementById('chatbotInput').value = question;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            if (!message) return;

            // Clear input
            input.value = '';

            // Hide suggestions after first message
            const suggestions = document.getElementById('chatbotSuggestions');
            if (suggestions) suggestions.style.display = 'none';

            // Add user message to chat
            addChatMessage(message, 'user');

            // Show typing indicator
            const typingId = showTypingIndicator();

            try {
                // Call the AI assistant API
                const response = await fetch('/api/assistant/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: message, context: { history: chatHistory.slice(-6) }, language: window.GASKIA.lang })
                });

                // Remove typing indicator
                removeTypingIndicator(typingId);

                if (response.ok) {
                    const data = await response.json();
                    addChatMessage(data.answer || data.response || 'I can help you with that.', 'bot', data);
                    chatHistory.push({ role: 'user', content: message });
                    chatHistory.push({ role: 'assistant', content: data.answer || data.response });
                } else {
                    addChatMessage(window.t('chatbot.error') || 'Sorry, I encountered an error. Please try again.', 'bot', null, true);
                }
            } catch (error) {
                removeTypingIndicator(typingId);
                addChatMessage(window.t('chatbot.error') || 'Sorry, I encountered an error. Please try again.', 'bot', null, true);
            }
        }

        function addChatMessage(text, sender, data = null, isError = false) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-message-${sender}${isError ? ' chat-message-error' : ''}`;

            let content = `<div class="chat-message-content">${formatChatMessage(text)}</div>`;

            // Add suggested actions if available
            if (data && data.suggested_actions && data.suggested_actions.length > 0) {
                content += `<div class="chat-actions">`;
                data.suggested_actions.slice(0, 3).forEach(action => {
                    content += `<button class="chat-action-btn" onclick="askQuestion('${action.replace(/'/g, "\\'")}')">${action}</button>`;
                });
                content += `</div>`;
            }

            // Add related metrics links if available
            if (data && data.related_metrics && data.related_metrics.length > 0) {
                content += `<div class="chat-links">`;
                data.related_metrics.slice(0, 2).forEach(metric => {
                    content += `<a href="${metric.url || '#'}" class="chat-link"><i data-lucide="external-link"></i>${metric.name || metric}</a>`;
                });
                content += `</div>`;
            }

            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            lucide.createIcons();
        }

        function formatChatMessage(text) {
            // Basic markdown-like formatting
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatbotMessages');
            const typingDiv = document.createElement('div');
            const typingId = 'typing-' + Date.now();
            typingDiv.id = typingId;
            typingDiv.className = 'chat-message chat-message-bot chat-typing';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return typingId;
        }

        function removeTypingIndicator(typingId) {
            const typing = document.getElementById(typingId);
            if (typing) typing.remove();
        }

        // =============================================
        // Global Search System
        // =============================================
        const searchIndex = [
            { type: 'page', title: 'Dashboard', url: '/', icon: 'home', keywords: ['home', 'overview', 'kpi', 'dashboard'] },
            { type: 'page', title: 'Unified View', url: '/unified', icon: 'layers', keywords: ['unified', 'all', 'metrics', 'view'] },
            { type: 'page', title: 'Executive View', url: '/executive', icon: 'briefcase', keywords: ['executive', 'business', 'kpi', 'summary'] },
            { type: 'page', title: 'Causal Analysis', url: '/causal', icon: 'git-branch', keywords: ['causal', 'root cause', 'analysis', 'graph'] },
            { type: 'page', title: 'Impact Analysis', url: '/impact', icon: 'trending-up', keywords: ['impact', 'business', 'effect'] },
            { type: 'page', title: 'Live Monitoring', url: '/monitoring', icon: 'activity', keywords: ['monitoring', 'live', 'real-time', 'alerts'] },
            { type: 'page', title: 'FinOps', url: '/finops', icon: 'wallet', keywords: ['finops', 'cost', 'budget', 'spend', 'finance'] },
            { type: 'page', title: 'GreenOps', url: '/greenops', icon: 'leaf', keywords: ['greenops', 'carbon', 'sustainability', 'environment'] },
            { type: 'page', title: 'Compliance', url: '/compliance', icon: 'shield-check', keywords: ['compliance', 'regulation', 'gdpr', 'audit'] },
            { type: 'page', title: 'Security Center', url: '/security', icon: 'lock', keywords: ['security', 'threats', 'vulnerabilities'] },
            { type: 'page', title: 'Personas & Guide', url: '/onboarding', icon: 'user-circle', keywords: ['personas', 'profile', 'onboarding', 'guide'] },
            { type: 'metric', title: 'Trust Score', url: '/#trust-score', icon: 'shield', keywords: ['trust', 'score', 'reliability'] },
            { type: 'metric', title: 'Data Drift', url: '/unified?metric=drift', icon: 'git-merge', keywords: ['drift', 'data', 'model'] },
            { type: 'metric', title: 'Daily Costs', url: '/finops', icon: 'dollar-sign', keywords: ['cost', 'daily', 'spend'] },
            { type: 'metric', title: 'Carbon Footprint', url: '/greenops', icon: 'cloud', keywords: ['carbon', 'co2', 'footprint'] },
            { type: 'action', title: 'Change Profile', url: '/onboarding', icon: 'users', keywords: ['change', 'switch', 'profile', 'persona'] },
            { type: 'action', title: 'Start Tour', url: '#tour', icon: 'play-circle', keywords: ['tour', 'guide', 'help', 'start'] },
        ];

        let searchResultsVisible = false;

        function handleGlobalSearch(event) {
            const query = event.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResultsContent');

            if (query.length < 1) {
                showDefaultSearchResults();
                return;
            }

            const results = searchIndex.filter(item => {
                return item.title.toLowerCase().includes(query) ||
                       item.keywords.some(k => k.includes(query));
            }).slice(0, 8);

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-empty">
                        <i data-lucide="search-x"></i>
                        <span>${window.t('search.no_results') || 'No results found'}</span>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = results.map(item => `
                    <a href="${item.url}" class="search-result-item" onclick="handleSearchResultClick(event, '${item.url}')">
                        <div class="search-result-icon">
                            <i data-lucide="${item.icon}"></i>
                        </div>
                        <div class="search-result-info">
                            <span class="search-result-title">${item.title}</span>
                            <span class="search-result-type">${item.type}</span>
                        </div>
                        <i data-lucide="arrow-right" class="search-result-arrow"></i>
                    </a>
                `).join('');
            }
            lucide.createIcons();
        }

        function showDefaultSearchResults() {
            const resultsContainer = document.getElementById('searchResultsContent');
            const recentPages = searchIndex.filter(i => i.type === 'page').slice(0, 5);
            resultsContainer.innerHTML = recentPages.map(item => `
                <a href="${item.url}" class="search-result-item">
                    <div class="search-result-icon">
                        <i data-lucide="${item.icon}"></i>
                    </div>
                    <div class="search-result-info">
                        <span class="search-result-title">${item.title}</span>
                        <span class="search-result-type">${item.type}</span>
                    </div>
                    <i data-lucide="arrow-right" class="search-result-arrow"></i>
                </a>
            `).join('');
            lucide.createIcons();
        }

        function showSearchResults() {
            const searchResults = document.getElementById('searchResults');
            searchResults.classList.add('active');
            searchResultsVisible = true;
            showDefaultSearchResults();
        }

        function hideSearchResults() {
            const searchResults = document.getElementById('searchResults');
            searchResults.classList.remove('active');
            searchResultsVisible = false;
        }

        function handleSearchResultClick(event, url) {
            if (url === '#tour') {
                event.preventDefault();
                hideSearchResults();
                startGuidedTour();
            } else {
                hideSearchResults();
            }
        }

        // Keyboard shortcut for search (Cmd/Ctrl + K)
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('globalSearchInput');
                searchInput.focus();
                showSearchResults();
            }
            if (e.key === 'Escape') {
                hideSearchResults();
                if (chatbotOpen) toggleChatbot();
            }
        });

        // Close search results on click outside
        document.addEventListener('click', (e) => {
            const globalSearch = document.getElementById('globalSearch');
            if (globalSearch && !globalSearch.contains(e.target)) {
                hideSearchResults();
            }
            // Close chatbot on outside click (except for the trigger)
            const chatbotContainer = document.getElementById('chatbotContainer');
            if (chatbotContainer && !chatbotContainer.contains(e.target) && chatbotOpen) {
                toggleChatbot();
            }
        });

        // Toast Notifications
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: 'check-circle',
                error: 'alert-circle',
                warning: 'alert-triangle',
                info: 'info'
            };

            toast.innerHTML = `
                <i data-lucide="${icons[type] || 'info'}"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i data-lucide="x"></i>
                </button>
            `;

            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
