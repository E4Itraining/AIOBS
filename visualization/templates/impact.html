{% extends "base.html" %}

{% set active_page = 'impact' %}

{% block page_title %}{{ t('nav.impact_analysis') }}{% endblock %}

{% block page_subtitle %}
<p>{{ t('impact.subtitle') or 'Quantify the business impact of AI system events' }}</p>
{% endblock %}

{% block sidebar_extra %}
<div class="nav-group">
    <span class="nav-group-title">{{ t('impact.event_types') or 'Event Types' }}</span>
    <button class="nav-link" onclick="analyzeEvent('model_drift')">
        <i data-lucide="activity"></i>
        <span>{{ t('impact.model_drift') or 'Model Drift' }}</span>
    </button>
    <button class="nav-link" onclick="analyzeEvent('model_degradation')">
        <i data-lucide="trending-down"></i>
        <span>{{ t('impact.degradation') or 'Degradation' }}</span>
    </button>
    <button class="nav-link" onclick="analyzeEvent('cost_anomaly')">
        <i data-lucide="dollar-sign"></i>
        <span>{{ t('impact.cost_anomaly') or 'Cost Anomaly' }}</span>
    </button>
    <button class="nav-link" onclick="analyzeEvent('latency_spike')">
        <i data-lucide="clock"></i>
        <span>{{ t('impact.latency_spike') or 'Latency Spike' }}</span>
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Impact Summary -->
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="kpi-icon danger">
            <i data-lucide="alert-circle"></i>
        </div>
        <div class="kpi-label">Total Impact (24h)</div>
        <div class="kpi-value" style="color: var(--color-danger);" id="totalImpact">-$--</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon primary">
            <i data-lucide="bar-chart-2"></i>
        </div>
        <div class="kpi-label">Events Analyzed</div>
        <div class="kpi-value" id="eventsCount">--</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon warning">
            <i data-lucide="target"></i>
        </div>
        <div class="kpi-label">Most Affected</div>
        <div class="kpi-value text-sm" id="mostAffected">--</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon success">
            <i data-lucide="trending-up"></i>
        </div>
        <div class="kpi-label">Trend vs Previous</div>
        <div class="kpi-value" id="impactTrend">--</div>
    </div>
</div>

<!-- Analysis Form -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">{{ t('impact.analyze_event') or 'Analyze Event' }}</h3>
    </div>
    <div class="grid grid-4 gap-4">
        <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Event Type</label>
            <select id="eventType" class="form-select">
                <option value="model_drift">Model Drift</option>
                <option value="model_degradation">Model Degradation</option>
                <option value="cost_anomaly">Cost Anomaly</option>
                <option value="latency_spike">Latency Spike</option>
                <option value="error_rate_increase">Error Rate Increase</option>
                <option value="security_incident">Security Incident</option>
                <option value="compliance_violation">Compliance Violation</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Affected Models</label>
            <input type="text" id="affectedModels" class="form-input" placeholder="e.g., recommendation-v2, fraud-v1">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Time Window</label>
            <select id="timeWindow" class="form-select">
                <option value="1">Last 1 hour</option>
                <option value="24" selected>Last 24 hours</option>
                <option value="168">Last 7 days</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
            <button class="btn btn-primary" onclick="runAnalysis()" style="width: 100%;">
                <i data-lucide="search"></i>
                Analyze
            </button>
        </div>
    </div>
</div>

<!-- Impact Results -->
<div class="grid grid-2 mb-6">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ t('impact.breakdown') or 'Impact Breakdown' }}</h3>
        </div>
        <div id="impactBreakdown">
            <div class="empty-state">
                <i data-lucide="bar-chart-2"></i>
                <h3>Run an analysis</h3>
                <p class="text-muted">Select an event type and run analysis to see results</p>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Impact by Domain</h3>
        </div>
        <div class="chart-container" style="height: 300px;">
            <canvas id="domainChart"></canvas>
        </div>
    </div>
</div>

<!-- Recommendations & Mitigations -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">Recommendations & Mitigations</h3>
    </div>
    <div class="grid grid-2 gap-6">
        <div>
            <h4 class="text-sm text-muted mb-4">Recommendations</h4>
            <ul id="recommendations" style="list-style: none; padding: 0;">
                <li class="text-muted">Run an analysis to see recommendations</li>
            </ul>
        </div>
        <div>
            <h4 class="text-sm text-muted mb-4">Mitigation Actions</h4>
            <ul id="mitigations" style="list-style: none; padding: 0;">
                <li class="text-muted">Run an analysis to see mitigations</li>
            </ul>
        </div>
    </div>
</div>

<!-- Impact History -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Impact Trend</h3>
    </div>
    <div class="chart-container">
        <canvas id="impactTrendChart"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let domainChart = null;
let trendChart = null;

document.addEventListener('DOMContentLoaded', async () => {
    await loadSummary();
    initTrendChart();
    lucide.createIcons();
});

async function loadSummary() {
    try {
        const response = await fetch('/api/metrics/impact/summary');
        const result = await response.json();

        if (result.success) {
            const data = result.data;

            document.getElementById('totalImpact').textContent = '-$' + Math.abs(data.total_monetary_impact).toLocaleString();
            document.getElementById('eventsCount').textContent = data.total_events;

            const topModel = data.top_affected_models?.[0];
            if (topModel) {
                document.getElementById('mostAffected').textContent = topModel.model;
            }

            const trendEl = document.getElementById('impactTrend');
            trendEl.innerHTML = `
                <span class="kpi-trend ${data.trend_pct < 0 ? 'down' : 'up'}">
                    <i data-lucide="trending-${data.trend_pct < 0 ? 'down' : 'up'}"></i>
                    ${data.trend_pct}%
                </span>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading summary:', error);
    }
}

async function runAnalysis() {
    const eventType = document.getElementById('eventType').value;
    const models = document.getElementById('affectedModels').value;
    const hours = document.getElementById('timeWindow').value;

    try {
        const response = await fetch(`/api/metrics/impact/analyze?event_type=${eventType}&affected_models=${models}&hours=${hours}`, {
            method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
            displayResults(result.data);
            showToast('Analysis complete', 'success');
        }
    } catch (error) {
        console.error('Error running analysis:', error);
        showToast('Analysis failed', 'error');
    }
}

function analyzeEvent(eventType) {
    document.getElementById('eventType').value = eventType;
    runAnalysis();
}

function displayResults(data) {
    // Impact breakdown
    const severityColors = {
        critical: 'var(--color-danger)',
        high: 'var(--color-warning)',
        medium: 'var(--color-info)',
        low: 'var(--color-success)'
    };

    document.getElementById('impactBreakdown').innerHTML = `
        <div class="mb-4">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: ${severityColors[data.overall_severity] || 'var(--color-info)'}; color: white; border-radius: var(--radius-lg);">
                <span class="font-semibold">${data.overall_severity.toUpperCase()}</span>
                <span style="font-size: 1.5rem; font-weight: 700;">-$${Math.abs(data.total_monetary_impact).toLocaleString()}</span>
            </div>
        </div>
        ${data.impacts.map(impact => `
            <div class="flex justify-between items-center" style="padding: 0.75rem; border-bottom: 1px solid var(--border-color);">
                <div>
                    <div class="font-semibold">${impact.metric}</div>
                    <div class="text-sm text-muted">${impact.domain}</div>
                </div>
                <div class="text-right">
                    <div class="font-semibold" style="color: ${impact.monetary_impact < 0 ? 'var(--color-danger)' : 'var(--color-success)'};">
                        ${impact.monetary_impact < 0 ? '-' : '+'}$${Math.abs(impact.monetary_impact).toLocaleString()}
                    </div>
                    <span class="badge badge-${impact.severity === 'critical' ? 'critical' : impact.severity === 'high' ? 'warning' : 'healthy'}">
                        ${impact.severity}
                    </span>
                </div>
            </div>
        `).join('')}
    `;

    // Domain chart
    updateDomainChart(data.impacts);

    // Recommendations
    document.getElementById('recommendations').innerHTML = data.recommendations.map(rec => `
        <li class="flex items-start gap-2 mb-2">
            <i data-lucide="check-circle" style="color: var(--color-success); flex-shrink: 0; margin-top: 2px; width: 18px; height: 18px;"></i>
            <span>${rec}</span>
        </li>
    `).join('');

    // Mitigations
    document.getElementById('mitigations').innerHTML = data.mitigations.map(mit => `
        <li class="flex items-start gap-2 mb-2">
            <i data-lucide="shield" style="color: var(--color-primary); flex-shrink: 0; margin-top: 2px; width: 18px; height: 18px;"></i>
            <span>${mit}</span>
        </li>
    `).join('');

    lucide.createIcons();
}

function updateDomainChart(impacts) {
    const domains = {};
    impacts.forEach(i => {
        domains[i.domain] = (domains[i.domain] || 0) + Math.abs(i.monetary_impact || 0);
    });

    if (domainChart) domainChart.destroy();

    const ctx = document.getElementById('domainChart').getContext('2d');
    domainChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(domains),
            datasets: [{
                label: 'Impact ($)',
                data: Object.values(domains),
                backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#6366f1'],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { color: '#e2e8f0' },
                    ticks: {
                        color: '#64748b',
                        callback: v => '$' + v.toLocaleString()
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: '#64748b' }
                }
            }
        }
    });
}

function initTrendChart() {
    const ctx = document.getElementById('impactTrendChart').getContext('2d');

    const labels = [];
    const data = [];
    const now = new Date();

    for (let i = 23; i >= 0; i--) {
        const d = new Date(now - i * 3600000);
        labels.push(d.getHours() + ':00');
        data.push(Math.random() * 10000 + 2000);
    }

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Hourly Impact',
                data: data,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#64748b', font: { size: 11 } }
                },
                y: {
                    grid: { color: '#e2e8f0' },
                    ticks: {
                        color: '#64748b',
                        callback: v => '$' + v.toLocaleString()
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
