{% extends "base.html" %}

{% set active_page = 'global' %}

{% block page_title %}{{ t('nav.global_view') or 'Vue Globale' }}{% endblock %}

{% block content %}
<div class="global-dashboard page-transition-enter">
    <!-- Hero Section -->
    <div class="dashboard-hero">
        <div class="hero-content">
            <div class="hero-badge">
                <i data-lucide="globe"></i>
                <span>Vue Globale</span>
            </div>
            <h1>Tableau de Bord Global</h1>
            <p class="hero-subtitle">
                Vue consolid√©e de votre portefeuille IA. Tous les KPIs essentiels pour piloter vos syst√®mes d'intelligence artificielle.
            </p>
        </div>
        <div class="hero-actions">
            <a href="/personas" class="btn btn-outline">
                <i data-lucide="compass"></i>
                <span>Vues par Persona</span>
            </a>
            <button class="btn btn-primary" onclick="window.GASKIA_UX && window.GASKIA_UX.toggleQuickInsights()">
                <i data-lucide="zap"></i>
                <span>Quick Insights</span>
            </button>
        </div>
    </div>

    <!-- KPI Overview Cards -->
    <div class="kpi-grid kpi-grid-5">
        <div class="kpi-card kpi-card-clickable" data-metric="trust_score" onclick="openTrustDeepDive()">
            <div class="kpi-header">
                <div class="kpi-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <i data-lucide="shield-check"></i>
                </div>
                <div class="kpi-trend trend-up">
                    <i data-lucide="trending-up"></i>
                    <span>+2.3%</span>
                </div>
            </div>
            <div class="kpi-value" id="kpiTrustScore">87%</div>
            <div class="kpi-label">Score de Confiance</div>
            <div class="kpi-deep-dive-hint">
                <i data-lucide="maximize-2"></i>
                <span>Cliquer pour Deep Dive</span>
            </div>
        </div>

        <div class="kpi-card" data-metric="models_count">
            <div class="kpi-header">
                <div class="kpi-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                    <i data-lucide="brain"></i>
                </div>
                <div class="kpi-trend trend-neutral">
                    <i data-lucide="minus"></i>
                    <span>stable</span>
                </div>
            </div>
            <div class="kpi-value" id="kpiModelsCount">24</div>
            <div class="kpi-label">Mod√®les IA Actifs</div>
            <div class="kpi-sparkline" id="sparkModels"></div>
        </div>

        <div class="kpi-card" data-metric="daily_cost">
            <div class="kpi-header">
                <div class="kpi-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <i data-lucide="coins"></i>
                </div>
                <div class="kpi-trend trend-down">
                    <i data-lucide="trending-down"></i>
                    <span>-8.5%</span>
                </div>
            </div>
            <div class="kpi-value" id="kpiDailyCost">‚Ç¨2,847</div>
            <div class="kpi-label">Co√ªt Journalier</div>
            <div class="kpi-sparkline" id="sparkCost"></div>
        </div>

        <div class="kpi-card" data-metric="compliance">
            <div class="kpi-header">
                <div class="kpi-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                    <i data-lucide="scale"></i>
                </div>
                <div class="kpi-trend trend-up">
                    <i data-lucide="trending-up"></i>
                    <span>+5%</span>
                </div>
            </div>
            <div class="kpi-value" id="kpiCompliance">92%</div>
            <div class="kpi-label">Conformit√© AI Act</div>
            <div class="kpi-sparkline" id="sparkCompliance"></div>
        </div>

        <div class="kpi-card" data-metric="carbon">
            <div class="kpi-header">
                <div class="kpi-icon" style="background: linear-gradient(135deg, #059669, #047857);">
                    <i data-lucide="leaf"></i>
                </div>
                <div class="kpi-trend trend-down">
                    <i data-lucide="trending-down"></i>
                    <span>-12%</span>
                </div>
            </div>
            <div class="kpi-value" id="kpiCarbon">142 kg</div>
            <div class="kpi-label">CO‚ÇÇ Journalier</div>
            <div class="kpi-sparkline" id="sparkCarbon"></div>
        </div>
    </div>

    <!-- Persona Quick Access -->
    <div class="section-header">
        <h2>
            <i data-lucide="users"></i>
            Vues par Persona
        </h2>
        <p>Acc√©dez rapidement aux tableaux de bord adapt√©s √† votre r√¥le</p>
    </div>

    <div class="persona-quick-grid">
        <!-- Dirigeant -->
        <a href="/dirigeant" class="persona-quick-card" style="--accent: #10b981;">
            <div class="pq-icon">
                <i data-lucide="building-2"></i>
            </div>
            <div class="pq-content">
                <h3>Dirigeant / Business</h3>
                <p>Vision strat√©gique, ROI, risques m√©tier et conformit√© globale</p>
                <div class="pq-metrics">
                    <span class="pq-metric">
                        <i data-lucide="trending-up"></i>
                        ROI +18%
                    </span>
                    <span class="pq-metric">
                        <i data-lucide="alert-triangle"></i>
                        3 risques
                    </span>
                </div>
            </div>
            <i data-lucide="arrow-right" class="pq-arrow"></i>
        </a>

        <!-- Tech DSI/RSSI -->
        <a href="/tech" class="persona-quick-card" style="--accent: #6366f1;">
            <div class="pq-icon">
                <i data-lucide="server"></i>
            </div>
            <div class="pq-content">
                <h3>Tech (DSI / RSSI)</h3>
                <p>Infrastructure, s√©curit√©, performance et gouvernance IT</p>
                <div class="pq-metrics">
                    <span class="pq-metric">
                        <i data-lucide="activity"></i>
                        99.9% uptime
                    </span>
                    <span class="pq-metric">
                        <i data-lucide="shield"></i>
                        Posture A
                    </span>
                </div>
            </div>
            <i data-lucide="arrow-right" class="pq-arrow"></i>
        </a>

        <!-- Juridique -->
        <a href="/juridique" class="persona-quick-card" style="--accent: #f59e0b;">
            <div class="pq-icon">
                <i data-lucide="gavel"></i>
            </div>
            <div class="pq-content">
                <h3>Juridique / Conformit√©</h3>
                <p>EU AI Act, RGPD, audit trail et documentation r√©glementaire</p>
                <div class="pq-metrics">
                    <span class="pq-metric">
                        <i data-lucide="check-circle"></i>
                        92% conforme
                    </span>
                    <span class="pq-metric">
                        <i data-lucide="file-text"></i>
                        12 audits
                    </span>
                </div>
            </div>
            <i data-lucide="arrow-right" class="pq-arrow"></i>
        </a>

        <!-- Financier -->
        <a href="/financier" class="persona-quick-card" style="--accent: #ef4444;">
            <div class="pq-icon">
                <i data-lucide="wallet"></i>
            </div>
            <div class="pq-content">
                <h3>Financier / FinOps</h3>
                <p>Co√ªts, budgets, ROI et optimisation des d√©penses IA</p>
                <div class="pq-metrics">
                    <span class="pq-metric">
                        <i data-lucide="piggy-bank"></i>
                        ‚Ç¨24K √©conomis√©s
                    </span>
                    <span class="pq-metric">
                        <i data-lucide="target"></i>
                        Budget OK
                    </span>
                </div>
            </div>
            <i data-lucide="arrow-right" class="pq-arrow"></i>
        </a>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- System Health Overview -->
        <div class="card card-lg">
            <div class="card-header">
                <h3>
                    <i data-lucide="heart-pulse"></i>
                    Sant√© des Syst√®mes IA
                </h3>
                <div class="card-actions">
                    <button class="btn btn-ghost btn-sm" onclick="refreshSystemHealth()">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="health-grid">
                    <div class="health-item health-good">
                        <div class="health-icon">
                            <i data-lucide="check-circle"></i>
                        </div>
                        <div class="health-info">
                            <span class="health-count">18</span>
                            <span class="health-label">Op√©rationnels</span>
                        </div>
                    </div>
                    <div class="health-item health-warning">
                        <div class="health-icon">
                            <i data-lucide="alert-triangle"></i>
                        </div>
                        <div class="health-info">
                            <span class="health-count">4</span>
                            <span class="health-label">D√©grad√©s</span>
                        </div>
                    </div>
                    <div class="health-item health-critical">
                        <div class="health-icon">
                            <i data-lucide="alert-circle"></i>
                        </div>
                        <div class="health-info">
                            <span class="health-count">2</span>
                            <span class="health-label">Critiques</span>
                        </div>
                    </div>
                </div>
                <div class="health-chart" id="healthDonutChart"></div>
            </div>
        </div>

        <!-- Trust Score Trend -->
        <div class="card card-lg">
            <div class="card-header">
                <h3>
                    <i data-lucide="trending-up"></i>
                    √âvolution du Score de Confiance
                </h3>
                <div class="time-selector">
                    <button class="time-btn active" data-range="24h">24h</button>
                    <button class="time-btn" data-range="7d">7j</button>
                    <button class="time-btn" data-range="30d">30j</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="trustTrendChart" height="200"></canvas>
            </div>
        </div>

        <!-- Cost Breakdown -->
        <div class="card">
            <div class="card-header">
                <h3>
                    <i data-lucide="pie-chart"></i>
                    R√©partition des Co√ªts
                </h3>
            </div>
            <div class="card-body">
                <canvas id="costBreakdownChart" height="200"></canvas>
                <div class="cost-legend" id="costLegend"></div>
            </div>
        </div>

        <!-- Compliance Status -->
        <div class="card">
            <div class="card-header">
                <h3>
                    <i data-lucide="shield-check"></i>
                    Conformit√© R√©glementaire
                </h3>
            </div>
            <div class="card-body">
                <div class="compliance-list">
                    <div class="compliance-item">
                        <div class="compliance-framework">
                            <span class="compliance-icon eu-ai-act">üá™üá∫</span>
                            <span>EU AI Act</span>
                        </div>
                        <div class="compliance-bar">
                            <div class="compliance-progress" style="width: 92%;"></div>
                        </div>
                        <span class="compliance-percent">92%</span>
                    </div>
                    <div class="compliance-item">
                        <div class="compliance-framework">
                            <span class="compliance-icon gdpr">üîí</span>
                            <span>RGPD</span>
                        </div>
                        <div class="compliance-bar">
                            <div class="compliance-progress" style="width: 98%;"></div>
                        </div>
                        <span class="compliance-percent">98%</span>
                    </div>
                    <div class="compliance-item">
                        <div class="compliance-framework">
                            <span class="compliance-icon iso">üìã</span>
                            <span>ISO 27001</span>
                        </div>
                        <div class="compliance-bar">
                            <div class="compliance-progress" style="width: 85%;"></div>
                        </div>
                        <span class="compliance-percent">85%</span>
                    </div>
                    <div class="compliance-item">
                        <div class="compliance-framework">
                            <span class="compliance-icon nist">üõ°Ô∏è</span>
                            <span>NIST AI RMF</span>
                        </div>
                        <div class="compliance-bar">
                            <div class="compliance-progress" style="width: 78%;"></div>
                        </div>
                        <span class="compliance-percent">78%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="card card-full">
            <div class="card-header">
                <h3>
                    <i data-lucide="bell"></i>
                    Alertes R√©centes
                </h3>
                <a href="/monitoring" class="btn btn-ghost btn-sm">
                    Voir tout
                    <i data-lucide="arrow-right"></i>
                </a>
            </div>
            <div class="card-body">
                <div class="alerts-table">
                    <div class="alert-row alert-critical">
                        <div class="alert-severity">
                            <i data-lucide="alert-circle"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">Drift critique d√©tect√© - Mod√®le de scoring cr√©dit</div>
                            <div class="alert-meta">
                                <span><i data-lucide="clock"></i> Il y a 23 min</span>
                                <span><i data-lucide="brain"></i> credit-scoring-v2</span>
                            </div>
                        </div>
                        <div class="alert-actions">
                            <button class="btn btn-ghost btn-sm">Investiguer</button>
                        </div>
                    </div>
                    <div class="alert-row alert-warning">
                        <div class="alert-severity">
                            <i data-lucide="alert-triangle"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">Latence √©lev√©e - API recommendation</div>
                            <div class="alert-meta">
                                <span><i data-lucide="clock"></i> Il y a 1h</span>
                                <span><i data-lucide="server"></i> reco-engine-prod</span>
                            </div>
                        </div>
                        <div class="alert-actions">
                            <button class="btn btn-ghost btn-sm">Voir</button>
                        </div>
                    </div>
                    <div class="alert-row alert-info">
                        <div class="alert-severity">
                            <i data-lucide="info"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">D√©passement budget quotidien (alerte pr√©ventive)</div>
                            <div class="alert-meta">
                                <span><i data-lucide="clock"></i> Il y a 2h</span>
                                <span><i data-lucide="coins"></i> FinOps</span>
                            </div>
                        </div>
                        <div class="alert-actions">
                            <button class="btn btn-ghost btn-sm">D√©tails</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trust Score Deep Dive Modal -->
<div class="modal-overlay" id="trustDeepDiveModal">
    <div class="modal-container modal-xl">
        <div class="modal-header">
            <h2>
                <i data-lucide="shield-check"></i>
                Deep Dive - Score de Confiance
            </h2>
            <button class="modal-close" onclick="closeTrustDeepDive()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Overview Header -->
            <div class="deep-dive-controls">
                <div class="framework-overview-header">
                    <div class="trust-score-large">
                        <div class="score-circle-lg">
                            <svg viewBox="0 0 100 100">
                                <defs>
                                    <linearGradient id="trustGradientLg" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#10b981"/>
                                        <stop offset="100%" style="stop-color:#34d399"/>
                                    </linearGradient>
                                </defs>
                                <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border-color)" stroke-width="6"/>
                                <circle cx="50" cy="50" r="45" fill="none" stroke="url(#trustGradientLg)" stroke-width="6"
                                    stroke-dasharray="246" stroke-dashoffset="37" stroke-linecap="round"
                                    transform="rotate(-90 50 50)"/>
                            </svg>
                            <div class="score-value-lg">
                                <span class="grade">87%</span>
                                <span class="score">Global</span>
                            </div>
                        </div>
                    </div>
                    <div class="framework-meta">
                        <div class="meta-item">
                            <i data-lucide="calendar"></i>
                            <span>Mise √† jour : <strong>Temps r√©el</strong></span>
                        </div>
                        <div class="meta-item">
                            <i data-lucide="trending-up"></i>
                            <span>Tendance : <strong class="text-success">+2.3% cette semaine</strong></span>
                        </div>
                        <div class="meta-item">
                            <i data-lucide="target"></i>
                            <span>Objectif : <strong>90% fin Q1</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trust Components -->
            <div class="deep-dive-kpis">
                <div class="deep-dive-kpi">
                    <div class="deep-dive-kpi-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                        <i data-lucide="activity"></i>
                    </div>
                    <div class="deep-dive-kpi-content">
                        <span class="deep-dive-kpi-value">92%</span>
                        <span class="deep-dive-kpi-label">Fiabilit√©</span>
                        <span class="deep-dive-kpi-trend up"><i data-lucide="trending-up"></i> +1.5%</span>
                    </div>
                </div>
                <div class="deep-dive-kpi">
                    <div class="deep-dive-kpi-icon" style="background: linear-gradient(135deg, #6366f1, #818cf8);">
                        <i data-lucide="git-compare"></i>
                    </div>
                    <div class="deep-dive-kpi-content">
                        <span class="deep-dive-kpi-value">85%</span>
                        <span class="deep-dive-kpi-label">Stabilit√© (Drift)</span>
                        <span class="deep-dive-kpi-trend up"><i data-lucide="trending-up"></i> +3%</span>
                    </div>
                </div>
                <div class="deep-dive-kpi">
                    <div class="deep-dive-kpi-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                        <i data-lucide="brain"></i>
                    </div>
                    <div class="deep-dive-kpi-content">
                        <span class="deep-dive-kpi-value">88%</span>
                        <span class="deep-dive-kpi-label">Qualit√© Cognitive</span>
                        <span class="deep-dive-kpi-trend up"><i data-lucide="trending-up"></i> +2%</span>
                    </div>
                </div>
                <div class="deep-dive-kpi">
                    <div class="deep-dive-kpi-icon" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                        <i data-lucide="scale"></i>
                    </div>
                    <div class="deep-dive-kpi-content">
                        <span class="deep-dive-kpi-value">92%</span>
                        <span class="deep-dive-kpi-label">Conformit√©</span>
                        <span class="deep-dive-kpi-trend up"><i data-lucide="trending-up"></i> +5%</span>
                    </div>
                </div>
            </div>

            <!-- Trust by Model -->
            <div class="deep-dive-table-section">
                <h4>Score de confiance par mod√®le IA</h4>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mod√®le IA</th>
                                <th>Fiabilit√©</th>
                                <th>Drift</th>
                                <th>Qualit√©</th>
                                <th>Score Global</th>
                                <th>Tendance</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Fraud Detection</strong></td>
                                <td>96%</td>
                                <td>94%</td>
                                <td>92%</td>
                                <td><strong>94%</strong></td>
                                <td><span class="trend-up"><i data-lucide="trending-up"></i> +2%</span></td>
                                <td><span class="badge badge-success">Excellent</span></td>
                            </tr>
                            <tr>
                                <td><strong>Scoring Cr√©dit</strong></td>
                                <td>93%</td>
                                <td>78%</td>
                                <td>88%</td>
                                <td><strong>86%</strong></td>
                                <td><span class="trend-down"><i data-lucide="trending-down"></i> -3%</span></td>
                                <td><span class="badge badge-warning">Drift d√©tect√©</span></td>
                            </tr>
                            <tr>
                                <td><strong>Chatbot Client</strong></td>
                                <td>91%</td>
                                <td>88%</td>
                                <td>90%</td>
                                <td><strong>90%</strong></td>
                                <td><span class="trend-up"><i data-lucide="trending-up"></i> +1%</span></td>
                                <td><span class="badge badge-success">Bon</span></td>
                            </tr>
                            <tr>
                                <td><strong>Recommandation</strong></td>
                                <td>89%</td>
                                <td>85%</td>
                                <td>87%</td>
                                <td><strong>87%</strong></td>
                                <td><span class="trend-neutral"><i data-lucide="minus"></i> Stable</span></td>
                                <td><span class="badge badge-success">Bon</span></td>
                            </tr>
                            <tr>
                                <td><strong>KYC Automation</strong></td>
                                <td>85%</td>
                                <td>82%</td>
                                <td>80%</td>
                                <td><strong>82%</strong></td>
                                <td><span class="trend-down"><i data-lucide="trending-down"></i> -2%</span></td>
                                <td><span class="badge badge-warning">√Ä surveiller</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="deep-dive-recommendations">
                <h4>Actions recommand√©es</h4>
                <div class="recommendations-list">
                    <div class="recommendation-item warning">
                        <div class="recommendation-icon">
                            <i data-lucide="alert-triangle"></i>
                        </div>
                        <div class="recommendation-content">
                            <h5>Investiguer le drift sur Scoring Cr√©dit</h5>
                            <p>Drift critique d√©tect√©. R√©viser les donn√©es d'entra√Ænement et envisager un r√©entra√Ænement.</p>
                        </div>
                    </div>
                    <div class="recommendation-item">
                        <div class="recommendation-icon">
                            <i data-lucide="refresh-cw"></i>
                        </div>
                        <div class="recommendation-content">
                            <h5>Mise √† jour du mod√®le KYC</h5>
                            <p>Score de qualit√© en baisse. Planifier une mise √† jour du mod√®le avec les nouvelles donn√©es.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeTrustDeepDive()">Fermer</button>
            <button class="btn btn-primary" onclick="exportTrustReport()">
                <i data-lucide="download"></i>
                Exporter le rapport
            </button>
        </div>
    </div>
</div>

<style>
/* Global Dashboard Styles */
.global-dashboard {
    padding: var(--space-6);
    max-width: 1600px;
    margin: 0 auto;
}

.dashboard-hero {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-6) 0;
    margin-bottom: var(--space-6);
}

.hero-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: linear-gradient(135deg, var(--color-or-sahel), var(--color-terre-cuite));
    color: white;
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--space-3);
}

.hero-badge svg { width: 16px; height: 16px; }

.hero-content h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: var(--space-2);
    background: linear-gradient(135deg, var(--text-primary), var(--color-or-sahel));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.hero-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
    max-width: 500px;
}

.hero-actions {
    display: flex;
    gap: var(--space-3);
}

/* KPI Grid 5 columns */
.kpi-grid-5 {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-8);
}

.kpi-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    transition: all 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-primary);
}

.kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-3);
}

.kpi-icon {
    width: 44px;
    height: 44px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.kpi-icon svg { width: 22px; height: 22px; }

.kpi-trend {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.75rem;
    font-weight: 600;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
}

.kpi-trend svg { width: 14px; height: 14px; }

.trend-up { color: #10b981; background: rgba(16, 185, 129, 0.1); }
.trend-down { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
.trend-neutral { color: var(--text-secondary); background: var(--bg-body); }

.kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-1);
}

.kpi-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.kpi-sparkline {
    height: 30px;
    margin-top: var(--space-3);
}

/* Section Header */
.section-header {
    margin-bottom: var(--space-5);
}

.section-header h2 {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 1.5rem;
    margin-bottom: var(--space-2);
}

.section-header h2 svg { width: 24px; height: 24px; color: var(--color-primary); }

.section-header p {
    color: var(--text-secondary);
}

/* Persona Quick Grid */
.persona-quick-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-8);
}

.persona-quick-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--bg-card);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.persona-quick-card:hover {
    border-color: var(--accent);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg), 0 0 0 1px var(--accent);
}

.pq-icon {
    width: 56px;
    height: 56px;
    background: var(--accent);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.pq-icon svg { width: 28px; height: 28px; }

.pq-content {
    flex: 1;
}

.pq-content h3 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: var(--space-1);
}

.pq-content p {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
}

.pq-metrics {
    display: flex;
    gap: var(--space-3);
}

.pq-metric {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.pq-metric svg { width: 12px; height: 12px; }

.pq-arrow {
    color: var(--text-tertiary);
    transition: transform 0.2s;
}

.persona-quick-card:hover .pq-arrow {
    transform: translateX(4px);
    color: var(--accent);
}

/* Dashboard Grid */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: var(--space-5);
}

.card { grid-column: span 4; }
.card-lg { grid-column: span 6; }
.card-full { grid-column: span 12; }

.card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    border-bottom: 1px solid var(--border-color);
}

.card-header h3 {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 1rem;
    font-weight: 600;
}

.card-header h3 svg { width: 18px; height: 18px; color: var(--color-primary); }

.card-body { padding: var(--space-4); }

/* Health Grid */
.health-grid {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
}

.health-item {
    flex: 1;
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    border-radius: var(--radius-md);
}

.health-good { background: rgba(16, 185, 129, 0.1); }
.health-warning { background: rgba(245, 158, 11, 0.1); }
.health-critical { background: rgba(239, 68, 68, 0.1); }

.health-good .health-icon { color: #10b981; }
.health-warning .health-icon { color: #f59e0b; }
.health-critical .health-icon { color: #ef4444; }

.health-icon svg { width: 24px; height: 24px; }

.health-count {
    font-size: 1.5rem;
    font-weight: 700;
    display: block;
}

.health-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Time Selector */
.time-selector {
    display: flex;
    gap: var(--space-1);
    background: var(--bg-body);
    padding: var(--space-1);
    border-radius: var(--radius-md);
}

.time-btn {
    padding: var(--space-1) var(--space-3);
    font-size: 0.75rem;
    font-weight: 500;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
}

.time-btn.active {
    background: var(--bg-card);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
}

/* Compliance List */
.compliance-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.compliance-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.compliance-framework {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    min-width: 120px;
    font-size: 0.875rem;
}

.compliance-icon {
    font-size: 1rem;
}

.compliance-bar {
    flex: 1;
    height: 8px;
    background: var(--bg-body);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.compliance-progress {
    height: 100%;
    background: linear-gradient(90deg, var(--color-or-sahel), #10b981);
    border-radius: var(--radius-full);
    transition: width 0.5s ease;
}

.compliance-percent {
    font-size: 0.875rem;
    font-weight: 600;
    min-width: 40px;
    text-align: right;
}

/* Alerts Table */
.alerts-table {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.alert-row {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    transition: background 0.2s;
}

.alert-row:hover { background: var(--bg-body); }

.alert-critical .alert-severity { color: #ef4444; }
.alert-warning .alert-severity { color: #f59e0b; }
.alert-info .alert-severity { color: #3b82f6; }

.alert-severity svg { width: 24px; height: 24px; }

.alert-content { flex: 1; }

.alert-title {
    font-weight: 500;
    margin-bottom: var(--space-1);
}

.alert-meta {
    display: flex;
    gap: var(--space-4);
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.alert-meta span {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.alert-meta svg { width: 12px; height: 12px; }

/* KPI Card Clickable */
.kpi-card-clickable {
    cursor: pointer;
    transition: all var(--transition-base);
}

.kpi-card-clickable:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-primary);
}

.kpi-deep-dive-hint {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-1);
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    margin-top: var(--space-2);
    opacity: 0;
    transition: opacity var(--transition-fast);
}

.kpi-deep-dive-hint svg { width: 12px; height: 12px; }

.kpi-card-clickable:hover .kpi-deep-dive-hint {
    opacity: 1;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base);
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal-container {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: scale(0.95) translateY(20px);
    transition: transform var(--transition-base);
}

.modal-overlay.active .modal-container {
    transform: scale(1) translateY(0);
}

.modal-xl { width: 100%; max-width: 1100px; }

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-5);
    border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: 1.25rem;
    font-weight: 600;
}

.modal-header h2 svg { width: 24px; height: 24px; color: var(--color-primary); }

.modal-close {
    width: 40px;
    height: 40px;
    border: none;
    background: var(--bg-hover);
    border-radius: var(--radius-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    transition: all var(--transition-fast);
}

.modal-close:hover { background: var(--color-danger-light); color: var(--color-danger); }
.modal-close svg { width: 20px; height: 20px; }

.modal-body { padding: var(--space-5); overflow-y: auto; flex: 1; }

.modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--border-color);
}

/* Deep Dive Styles */
.deep-dive-controls { margin-bottom: var(--space-5); }

.framework-overview-header {
    display: flex;
    align-items: center;
    gap: var(--space-6);
    padding: var(--space-4);
    background: var(--bg-hover);
    border-radius: var(--radius-lg);
}

.trust-score-large { flex-shrink: 0; }

.score-circle-lg { position: relative; width: 100px; height: 100px; }
.score-circle-lg svg { width: 100%; height: 100%; }

.score-value-lg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.score-value-lg .grade { display: block; font-size: 1.5rem; font-weight: 700; color: #10b981; line-height: 1; }
.score-value-lg .score { font-size: 0.75rem; color: var(--text-secondary); }

.framework-meta { display: flex; flex-direction: column; gap: var(--space-3); }

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.meta-item svg { width: 16px; height: 16px; }
.meta-item strong { color: var(--text-primary); }

.deep-dive-kpis {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-5);
}

.deep-dive-kpi {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
}

.deep-dive-kpi-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.deep-dive-kpi-icon svg { width: 24px; height: 24px; color: white; }
.deep-dive-kpi-content { display: flex; flex-direction: column; }
.deep-dive-kpi-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
.deep-dive-kpi-label { font-size: 0.75rem; color: var(--text-secondary); }

.deep-dive-kpi-trend {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.6875rem;
    font-weight: 500;
    margin-top: 2px;
}

.deep-dive-kpi-trend svg { width: 12px; height: 12px; }
.deep-dive-kpi-trend.up { color: var(--color-success); }
.deep-dive-kpi-trend.warning { color: var(--color-warning); }

.deep-dive-table-section { margin-bottom: var(--space-5); }
.deep-dive-table-section h4 { font-size: 1rem; font-weight: 600; margin-bottom: var(--space-3); }

.deep-dive-recommendations h4 { font-size: 1rem; font-weight: 600; margin-bottom: var(--space-3); }

.recommendations-list { display: flex; flex-direction: column; gap: var(--space-3); }

.recommendation-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--bg-hover);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--color-info);
}

.recommendation-item.warning { border-left-color: var(--color-warning); }

.recommendation-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-info-light);
    color: var(--color-info);
    flex-shrink: 0;
}

.recommendation-item.warning .recommendation-icon { background: var(--color-warning-light); color: var(--color-warning); }
.recommendation-icon svg { width: 16px; height: 16px; }
.recommendation-content { flex: 1; }
.recommendation-content h5 { font-size: 0.875rem; font-weight: 600; margin-bottom: var(--space-1); }
.recommendation-content p { font-size: 0.8125rem; color: var(--text-secondary); margin: 0; }

@media (max-width: 900px) { .deep-dive-kpis { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 600px) {
    .framework-overview-header { flex-direction: column; text-align: center; }
    .deep-dive-kpis { grid-template-columns: 1fr; }
}

/* Responsive */
@media (max-width: 1400px) {
    .kpi-grid-5 { grid-template-columns: repeat(3, 1fr); }
    .persona-quick-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 1024px) {
    .card-lg { grid-column: span 12; }
    .card { grid-column: span 6; }
}

@media (max-width: 768px) {
    .dashboard-hero { flex-direction: column; text-align: center; gap: var(--space-4); }
    .hero-content h1 { font-size: 1.75rem; }
    .kpi-grid-5 { grid-template-columns: repeat(2, 1fr); }
    .persona-quick-grid { grid-template-columns: 1fr; }
    .card { grid-column: span 12; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    initGlobalDashboard();
});

async function initGlobalDashboard() {
    // Load dashboard data
    try {
        const response = await fetch('/api/dashboard/overview');
        if (response.ok) {
            const data = await response.json();
            updateKPIs(data);
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }

    // Initialize charts
    initTrustTrendChart();
    initCostBreakdownChart();
    initHealthDonutChart();

    // Time selector events
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateTrustTrendChart(btn.dataset.range);
        });
    });
}

function updateKPIs(data) {
    if (data.trust_score) {
        document.getElementById('kpiTrustScore').textContent = Math.round(data.trust_score * 100) + '%';
    }
    if (data.daily_cost) {
        document.getElementById('kpiDailyCost').textContent = '‚Ç¨' + data.daily_cost.toLocaleString();
    }
}

function initTrustTrendChart() {
    const ctx = document.getElementById('trustTrendChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', 'Now'],
            datasets: [{
                label: 'Score de Confiance',
                data: [85, 84, 86, 87, 85, 88, 87],
                borderColor: '#D4A017',
                backgroundColor: 'rgba(212, 160, 23, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#D4A017'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    min: 70,
                    max: 100,
                    ticks: { callback: v => v + '%' }
                }
            }
        }
    });
}

function initCostBreakdownChart() {
    const ctx = document.getElementById('costBreakdownChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Inf√©rence', 'Training', 'Stockage', 'Infrastructure'],
            datasets: [{
                data: [45, 25, 15, 15],
                backgroundColor: ['#D4A017', '#6366f1', '#10b981', '#f59e0b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { usePointStyle: true, padding: 15 }
                }
            },
            cutout: '65%'
        }
    });
}

function initHealthDonutChart() {
    const container = document.getElementById('healthDonutChart');
    if (!container) return;

    // Simple SVG donut chart
    container.innerHTML = `
        <svg viewBox="0 0 100 100" style="width: 120px; height: 120px; margin: 0 auto; display: block;">
            <circle cx="50" cy="50" r="40" fill="none" stroke="#e5e7eb" stroke-width="12"/>
            <circle cx="50" cy="50" r="40" fill="none" stroke="#10b981" stroke-width="12"
                    stroke-dasharray="188 63" stroke-dashoffset="0" transform="rotate(-90 50 50)"/>
            <circle cx="50" cy="50" r="40" fill="none" stroke="#f59e0b" stroke-width="12"
                    stroke-dasharray="25 226" stroke-dashoffset="-188" transform="rotate(-90 50 50)"/>
            <circle cx="50" cy="50" r="40" fill="none" stroke="#ef4444" stroke-width="12"
                    stroke-dasharray="13 238" stroke-dashoffset="-213" transform="rotate(-90 50 50)"/>
            <text x="50" y="52" text-anchor="middle" font-size="14" font-weight="700" fill="currentColor">24</text>
            <text x="50" y="62" text-anchor="middle" font-size="6" fill="var(--text-secondary)">syst√®mes</text>
        </svg>
    `;
}

function updateTrustTrendChart(range) {
    // Placeholder for API call with different time ranges
    console.log('Updating chart for range:', range);
}

function refreshSystemHealth() {
    showToast('Actualisation des donn√©es...', 'info', 2000);
}

// Trust Score Deep Dive Modal
function openTrustDeepDive() {
    const modal = document.getElementById('trustDeepDiveModal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        lucide.createIcons();
    }
}

function closeTrustDeepDive() {
    const modal = document.getElementById('trustDeepDiveModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

function exportTrustReport() {
    showToast('Export du rapport de confiance en cours...', 'info', 3000);
    setTimeout(() => {
        showToast('Rapport export√© avec succ√®s', 'success', 3000);
    }, 1500);
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeTrustDeepDive();
    }
});

// Close modal on overlay click
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        closeTrustDeepDive();
    }
});
</script>
{% endblock %}
