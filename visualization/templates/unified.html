{% extends "base.html" %}

{% set active_page = 'unified' %}

{% block page_title %}{{ t('nav.unified_view') }}{% endblock %}

{% block page_subtitle %}
<p>{{ t('unified.subtitle') or 'Cross-domain monitoring and observability' }}</p>
{% endblock %}

{% block topbar_actions %}
<select id="timeRange" class="form-select" style="width: auto;">
    <option value="1">Last 1h</option>
    <option value="24" selected>Last 24h</option>
    <option value="168">Last 7d</option>
    <option value="720">Last 30d</option>
</select>
<button class="btn btn-primary" onclick="refreshData()">
    <i data-lucide="refresh-cw"></i>
    <span>Refresh</span>
</button>
{% endblock %}

{% block sidebar_extra %}
<div class="nav-group">
    <span class="nav-group-title">{{ t('nav.domains') }}</span>
    <a href="#models" class="nav-link">
        <i data-lucide="cpu"></i>
        <span>{{ t('nav.models') or 'Models' }}</span>
    </a>
    <a href="#infrastructure" class="nav-link">
        <i data-lucide="server"></i>
        <span>{{ t('nav.infrastructure') or 'Infrastructure' }}</span>
    </a>
    <a href="#costs" class="nav-link">
        <i data-lucide="dollar-sign"></i>
        <span>{{ t('nav.costs') or 'Costs' }}</span>
    </a>
    <a href="#carbon" class="nav-link">
        <i data-lucide="leaf"></i>
        <span>{{ t('nav.carbon') or 'Carbon' }}</span>
    </a>
    <a href="#compliance" class="nav-link">
        <i data-lucide="shield"></i>
        <span>{{ t('nav.compliance') or 'Compliance' }}</span>
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Service Topology -->
<div class="card mb-6" id="models">
    <div class="card-header">
        <h3 class="card-title">Service Topology</h3>
        <div class="flex gap-2">
            <span class="badge badge-healthy">
                <span class="badge-dot"></span>
                Healthy: <span id="healthyNodes">-</span>
            </span>
            <span class="badge badge-warning">
                <span class="badge-dot"></span>
                Degraded: <span id="degradedNodes">-</span>
            </span>
        </div>
    </div>
    <div id="topologyGraph" class="graph-container"></div>
</div>

<!-- Metrics Grid -->
<div class="grid grid-3 mb-6" id="infrastructure">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Latency P99</h3>
        </div>
        <div class="chart-container" style="height: 200px;">
            <canvas id="latencyChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Throughput</h3>
        </div>
        <div class="chart-container" style="height: 200px;">
            <canvas id="throughputChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Error Rate</h3>
        </div>
        <div class="chart-container" style="height: 200px;">
            <canvas id="errorChart"></canvas>
        </div>
    </div>
</div>

<!-- Cost & Carbon Row -->
<div class="grid grid-2 mb-6">
    <div class="card" id="costs">
        <div class="card-header">
            <h3 class="card-title">Cost Breakdown</h3>
        </div>
        <div class="grid grid-2">
            <div class="chart-container" style="height: 200px;">
                <canvas id="costChart"></canvas>
            </div>
            <div id="costDetails" class="flex flex-col justify-center">
                <div class="loader"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <div class="card" id="carbon">
        <div class="card-header">
            <h3 class="card-title">Carbon Metrics</h3>
        </div>
        <div class="grid grid-2">
            <div class="chart-container" style="height: 200px;">
                <canvas id="carbonChart"></canvas>
            </div>
            <div id="carbonDetails" class="flex flex-col justify-center">
                <div class="loader"><div class="spinner"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- SLO Status -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">SLO Status</h3>
        <span id="sloOverall" class="badge badge-healthy">
            <span class="badge-dot"></span>
            98.7% Compliant
        </span>
    </div>
    <div id="sloGrid" class="grid grid-auto">
        <div class="loader"><div class="spinner"></div></div>
    </div>
</div>

<!-- Compliance Status -->
<div class="card" id="compliance">
    <div class="card-header">
        <h3 class="card-title">Compliance Status</h3>
    </div>
    <div id="complianceGrid" class="grid grid-4">
        <div class="loader"><div class="spinner"></div></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let charts = {};

document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([
        loadTopology(),
        loadMetrics(),
        loadCosts(),
        loadCarbon(),
        loadSLO(),
        loadCompliance()
    ]);
    lucide.createIcons();
});

async function refreshData() {
    await Promise.all([
        loadMetrics(),
        loadCosts(),
        loadCarbon()
    ]);
    showToast('Data refreshed', 'success');
}

async function loadTopology() {
    const container = document.getElementById('topologyGraph');

    try {
        const response = await fetch('/api/dashboard/topology');
        const result = await response.json();

        if (result.success && result.data?.nodes?.length > 0) {
            renderTopology(result.data);

            const healthy = result.data.nodes.filter(n => n.status === 'healthy').length;
            const degraded = result.data.nodes.filter(n => n.status !== 'healthy').length;
            document.getElementById('healthyNodes').textContent = healthy;
            document.getElementById('degradedNodes').textContent = degraded;
        } else {
            container.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="network"></i>
                    <h3>No topology data</h3>
                    <p class="text-muted">Connect services to view the topology</p>
                </div>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading topology:', error);
        container.innerHTML = `
            <div class="empty-state">
                <i data-lucide="alert-circle"></i>
                <h3>Error loading topology</h3>
            </div>
        `;
        lucide.createIcons();
    }
}

function renderTopology(data) {
    const container = document.getElementById('topologyGraph');
    container.innerHTML = '';

    const width = container.clientWidth || 800;
    const height = 400;

    const svg = d3.select(container)
        .append('svg')
        .attr('width', '100%')
        .attr('height', height)
        .attr('viewBox', `0 0 ${width} ${height}`);

    svg.append('defs').append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '-0 -5 10 10')
        .attr('refX', 25)
        .attr('refY', 0)
        .attr('orient', 'auto')
        .attr('markerWidth', 8)
        .attr('markerHeight', 8)
        .append('path')
        .attr('d', 'M 0,-5 L 10,0 L 0,5')
        .attr('fill', '#94a3b8');

    const typeColors = {
        endpoint: '#6366f1',
        router: '#8b5cf6',
        model: '#10b981',
        data: '#3b82f6',
        infrastructure: '#f59e0b',
        monitoring: '#ef4444'
    };

    const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.edges).id(d => d.id).distance(120))
        .force('charge', d3.forceManyBody().strength(-400))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40));

    const link = svg.append('g')
        .selectAll('line')
        .data(data.edges)
        .join('line')
        .attr('stroke', '#e2e8f0')
        .attr('stroke-width', 2)
        .attr('marker-end', 'url(#arrowhead)');

    const node = svg.append('g')
        .selectAll('g')
        .data(data.nodes)
        .join('g')
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));

    node.append('circle')
        .attr('r', 25)
        .attr('fill', d => d.status === 'healthy' ? typeColors[d.type] || '#6366f1' :
            d.status === 'degraded' ? '#f59e0b' : '#ef4444')
        .attr('stroke', 'white')
        .attr('stroke-width', 3);

    node.append('text')
        .text(d => d.label.substring(0, 4))
        .attr('text-anchor', 'middle')
        .attr('dy', 4)
        .attr('fill', 'white')
        .attr('font-size', '10px')
        .attr('font-weight', '600');

    node.append('title')
        .text(d => `${d.label}\nType: ${d.type}\nStatus: ${d.status}`);

    simulation.on('tick', () => {
        data.nodes.forEach(d => {
            d.x = Math.max(30, Math.min(width - 30, d.x));
            d.y = Math.max(30, Math.min(height - 30, d.y));
        });

        link.attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }
}

async function loadMetrics() {
    const chartOptions = (unit) => ({
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } },
            y: { grid: { color: '#e2e8f0' }, ticks: { color: '#64748b', callback: v => v + unit } }
        }
    });

    const labels = generateLabels(24);

    // Latency
    if (charts.latency) charts.latency.destroy();
    charts.latency = new Chart(document.getElementById('latencyChart').getContext('2d'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                data: generateData(24, 80, 150),
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0
            }]
        },
        options: chartOptions('ms')
    });

    // Throughput
    if (charts.throughput) charts.throughput.destroy();
    charts.throughput = new Chart(document.getElementById('throughputChart').getContext('2d'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                data: generateData(24, 800, 1500),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0
            }]
        },
        options: chartOptions('/s')
    });

    // Error Rate
    if (charts.error) charts.error.destroy();
    charts.error = new Chart(document.getElementById('errorChart').getContext('2d'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                data: generateData(24, 0.1, 1.5),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0
            }]
        },
        options: chartOptions('%')
    });
}

async function loadCosts() {
    try {
        const response = await fetch('/api/dashboard/costs');
        const result = await response.json();

        if (result.success) {
            const data = result.data;

            if (charts.cost) charts.cost.destroy();
            charts.cost = new Chart(document.getElementById('costChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.by_category),
                    datasets: [{
                        data: Object.values(data.by_category),
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: { legend: { display: false } }
                }
            });

            document.getElementById('costDetails').innerHTML = `
                <div class="mb-4">
                    <div class="text-sm text-muted">Total (30d)</div>
                    <div class="kpi-value">$${data.total.toLocaleString()}</div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-muted">Forecast</div>
                    <div class="font-semibold" style="font-size: 1.25rem;">$${data.forecast_next_month.toLocaleString()}</div>
                </div>
                <div class="kpi-trend ${data.trend}">
                    <i data-lucide="trending-${data.trend}"></i>
                    <span>${data.trend_pct}% vs last period</span>
                </div>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading costs:', error);
    }
}

async function loadCarbon() {
    try {
        const response = await fetch('/api/dashboard/carbon');
        const result = await response.json();

        if (result.success) {
            const data = result.data;

            if (charts.carbon) charts.carbon.destroy();
            charts.carbon = new Chart(document.getElementById('carbonChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.by_activity),
                    datasets: [{
                        data: Object.values(data.by_activity),
                        backgroundColor: ['#10b981', '#22c55e', '#4ade80', '#86efac'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: { legend: { display: false } }
                }
            });

            document.getElementById('carbonDetails').innerHTML = `
                <div class="mb-4">
                    <div class="text-sm text-muted">Total (30d)</div>
                    <div class="kpi-value">${data.total_carbon_kg.toLocaleString()} kg</div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-muted">Green Energy</div>
                    <div class="font-semibold" style="font-size: 1.25rem; color: var(--color-success);">${data.green_energy_pct}%</div>
                </div>
                <div class="kpi-trend ${data.trend}">
                    <i data-lucide="trending-${data.trend}"></i>
                    <span>${data.trend_pct}% vs last period</span>
                </div>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading carbon:', error);
    }
}

async function loadSLO() {
    try {
        const response = await fetch('/api/dashboard/slo');
        const result = await response.json();

        if (result.success) {
            const data = result.data;

            document.getElementById('sloOverall').innerHTML = `
                <span class="badge-dot"></span>
                ${data.overall_compliance_pct}% Compliant
            `;

            document.getElementById('sloGrid').innerHTML = data.slos.map(slo => `
                <div class="card" style="padding: 1rem;">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-sm">${slo.name}</span>
                        <span class="badge badge-${slo.status}">${slo.status}</span>
                    </div>
                    <div class="kpi-value" style="font-size: 1.5rem;">${slo.current}${slo.unit}</div>
                    <div class="mt-4">
                        <div style="height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${slo.error_budget_remaining_pct}%; background: ${slo.error_budget_remaining_pct > 50 ? 'var(--color-success)' : slo.error_budget_remaining_pct > 20 ? 'var(--color-warning)' : 'var(--color-danger)'}; border-radius: 3px;"></div>
                        </div>
                        <div class="text-xs text-muted mt-1">Error budget: ${slo.error_budget_remaining_pct}% remaining</div>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading SLO:', error);
    }
}

async function loadCompliance() {
    try {
        const response = await fetch('/api/dashboard/compliance');
        const result = await response.json();

        if (result.success) {
            const data = result.data;

            document.getElementById('complianceGrid').innerHTML = Object.entries(data.categories).map(([key, cat]) => `
                <div class="card text-center" style="padding: 1rem;">
                    <div class="kpi-value" style="color: ${cat.status === 'compliant' ? 'var(--color-success)' : 'var(--color-warning)'};">
                        ${cat.score}
                    </div>
                    <div class="text-sm text-muted mb-2">${key.replace(/_/g, ' ')}</div>
                    <span class="badge badge-${cat.status === 'compliant' ? 'healthy' : 'warning'}">
                        ${cat.status}
                    </span>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading compliance:', error);
    }
}

function generateLabels(count) {
    const labels = [];
    const now = new Date();
    for (let i = count; i >= 0; i--) {
        const d = new Date(now - i * 3600000);
        labels.push(d.getHours() + ':00');
    }
    return labels;
}

function generateData(count, min, max) {
    const data = [];
    let value = (min + max) / 2;
    for (let i = 0; i < count; i++) {
        value += (Math.random() - 0.5) * (max - min) * 0.2;
        value = Math.max(min, Math.min(max, value));
        data.push(parseFloat(value.toFixed(2)));
    }
    return data;
}
</script>
{% endblock %}
