{% extends "base.html" %}

{% set active_page = 'unified' %}

{% block page_title %}{{ t('nav.unified_view') }}{% endblock %}

{% block page_subtitle %}
<p>{{ t('unified.subtitle') or 'Cross-domain monitoring and observability' }}</p>
{% endblock %}

{% block topbar_actions %}
<select id="timeRange" class="form-select" style="width: auto;">
    <option value="1">Last 1h</option>
    <option value="24" selected>Last 24h</option>
    <option value="168">Last 7d</option>
    <option value="720">Last 30d</option>
</select>
<button class="btn btn-primary" onclick="refreshData()">
    <i data-lucide="refresh-cw"></i>
    <span>Refresh</span>
</button>
{% endblock %}

{% block sidebar_extra %}
<div class="nav-group">
    <span class="nav-group-title">{{ t('nav.domains') }}</span>
    <a href="#models" class="nav-link">
        <i data-lucide="cpu"></i>
        <span>{{ t('nav.models') or 'Models' }}</span>
    </a>
    <a href="#infrastructure" class="nav-link">
        <i data-lucide="server"></i>
        <span>{{ t('nav.infrastructure') or 'Infrastructure' }}</span>
    </a>
    <a href="#costs" class="nav-link">
        <i data-lucide="dollar-sign"></i>
        <span>{{ t('nav.costs') or 'Costs' }}</span>
    </a>
    <a href="#carbon" class="nav-link">
        <i data-lucide="leaf"></i>
        <span>{{ t('nav.carbon') or 'Carbon' }}</span>
    </a>
    <a href="#compliance" class="nav-link">
        <i data-lucide="shield"></i>
        <span>{{ t('nav.compliance') or 'Compliance' }}</span>
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Service Topology -->
<div class="card mb-6" id="models">
    <div class="card-header">
        <h3 class="card-title">Service Topology</h3>
        <div class="flex gap-2">
            <span class="badge badge-healthy">
                <span class="badge-dot"></span>
                Healthy: <span id="healthyNodes">-</span>
            </span>
            <span class="badge badge-warning">
                <span class="badge-dot"></span>
                Degraded: <span id="degradedNodes">-</span>
            </span>
        </div>
    </div>
    <div id="topologyGraph" class="graph-container"></div>
</div>

<!-- Metrics Grid -->
<div class="grid grid-3 mb-6" id="infrastructure">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Latency P99</h3>
        </div>
        <div class="chart-container" style="height: 200px;">
            <canvas id="latencyChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Throughput</h3>
        </div>
        <div class="chart-container" style="height: 200px;">
            <canvas id="throughputChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Error Rate</h3>
        </div>
        <div class="chart-container" style="height: 200px;">
            <canvas id="errorChart"></canvas>
        </div>
    </div>
</div>

<!-- Cost & Carbon Row -->
<div class="grid grid-2 mb-6">
    <div class="card" id="costs">
        <div class="card-header">
            <h3 class="card-title">Cost Breakdown</h3>
        </div>
        <div class="grid grid-2">
            <div class="chart-container" style="height: 200px;">
                <canvas id="costChart"></canvas>
            </div>
            <div id="costDetails" class="flex flex-col justify-center">
                <div class="loader"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <div class="card" id="carbon">
        <div class="card-header">
            <h3 class="card-title">Carbon Metrics</h3>
        </div>
        <div class="grid grid-2">
            <div class="chart-container" style="height: 200px;">
                <canvas id="carbonChart"></canvas>
            </div>
            <div id="carbonDetails" class="flex flex-col justify-center">
                <div class="loader"><div class="spinner"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- SLO Status -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">SLO Status</h3>
        <span id="sloOverall" class="badge badge-healthy">
            <span class="badge-dot"></span>
            98.7% Compliant
        </span>
    </div>
    <div id="sloGrid" class="grid grid-auto">
        <div class="loader"><div class="spinner"></div></div>
    </div>
</div>

<!-- Compliance Status -->
<div class="card" id="compliance">
    <div class="card-header">
        <h3 class="card-title">Compliance Status</h3>
    </div>
    <div id="complianceGrid" class="grid grid-4">
        <div class="loader"><div class="spinner"></div></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let charts = {};

document.addEventListener('DOMContentLoaded', async () => {
    console.log('[Unified] Starting to load dashboard panels...');

    // Load all panels with individual error handling
    const results = await Promise.allSettled([
        loadTopology(),
        loadMetrics(),
        loadCosts(),
        loadCarbon(),
        loadSLO(),
        loadCompliance()
    ]);

    // Log any failures
    const panelNames = ['Topology', 'Metrics', 'Costs', 'Carbon', 'SLO', 'Compliance'];
    results.forEach((result, index) => {
        if (result.status === 'rejected') {
            console.error(`[Unified] Failed to load ${panelNames[index]}:`, result.reason);
        } else {
            console.log(`[Unified] Successfully loaded ${panelNames[index]}`);
        }
    });

    lucide.createIcons();
});

async function refreshData() {
    await Promise.all([
        loadMetrics(),
        loadCosts(),
        loadCarbon()
    ]);
    showToast('Data refreshed', 'success');
}

async function loadTopology() {
    const container = document.getElementById('topologyGraph');

    // Check if D3.js is available
    if (typeof d3 === 'undefined') {
        console.error('[Unified] D3.js is not loaded');
        container.innerHTML = `
            <div class="empty-state" style="display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%;">
                <i data-lucide="alert-circle" style="width: 48px; height: 48px; color: var(--color-warning);"></i>
                <h3>D3.js library not loaded</h3>
                <p class="text-muted">Unable to render topology graph</p>
            </div>
        `;
        lucide.createIcons();
        return;
    }

    try {
        console.log('[Unified] Fetching topology data...');
        const response = await fetch('/api/dashboard/topology');
        const result = await response.json();
        console.log('[Unified] Topology API response:', result);

        if (result.success && result.data?.nodes?.length > 0) {
            renderTopology(result.data);

            const healthy = result.data.nodes.filter(n => n.status === 'healthy').length;
            const degraded = result.data.nodes.filter(n => n.status !== 'healthy').length;
            document.getElementById('healthyNodes').textContent = healthy;
            document.getElementById('degradedNodes').textContent = degraded;
            console.log('[Unified] Topology rendered with', result.data.nodes.length, 'nodes');
        } else {
            console.warn('[Unified] No topology data returned:', result);
            container.innerHTML = `
                <div class="empty-state" style="display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%;">
                    <i data-lucide="network" style="width: 48px; height: 48px; color: var(--text-muted);"></i>
                    <h3>No topology data</h3>
                    <p class="text-muted">Connect services to view the topology</p>
                </div>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('[Unified] Error loading topology:', error);
        container.innerHTML = `
            <div class="empty-state" style="display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%;">
                <i data-lucide="alert-circle" style="width: 48px; height: 48px; color: var(--color-warning);"></i>
                <h3>Error loading topology</h3>
                <p class="text-muted">${error.message || 'Unknown error'}</p>
            </div>
        `;
        lucide.createIcons();
    }
}

function renderTopology(data) {
    const container = document.getElementById('topologyGraph');
    container.innerHTML = '';

    const width = container.clientWidth || 800;
    const height = 400;

    const svg = d3.select(container)
        .append('svg')
        .attr('width', '100%')
        .attr('height', height)
        .attr('viewBox', `0 0 ${width} ${height}`);

    svg.append('defs').append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '-0 -5 10 10')
        .attr('refX', 25)
        .attr('refY', 0)
        .attr('orient', 'auto')
        .attr('markerWidth', 8)
        .attr('markerHeight', 8)
        .append('path')
        .attr('d', 'M 0,-5 L 10,0 L 0,5')
        .attr('fill', '#94a3b8');

    const typeColors = {
        endpoint: '#6366f1',
        router: '#8b5cf6',
        model: '#10b981',
        data: '#3b82f6',
        infrastructure: '#f59e0b',
        monitoring: '#ef4444'
    };

    const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.edges).id(d => d.id).distance(120))
        .force('charge', d3.forceManyBody().strength(-400))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40));

    const link = svg.append('g')
        .selectAll('line')
        .data(data.edges)
        .join('line')
        .attr('stroke', '#e2e8f0')
        .attr('stroke-width', 2)
        .attr('marker-end', 'url(#arrowhead)');

    const node = svg.append('g')
        .selectAll('g')
        .data(data.nodes)
        .join('g')
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));

    node.append('circle')
        .attr('r', 25)
        .attr('fill', d => d.status === 'healthy' ? typeColors[d.type] || '#6366f1' :
            d.status === 'degraded' ? '#f59e0b' : '#ef4444')
        .attr('stroke', 'white')
        .attr('stroke-width', 3);

    node.append('text')
        .text(d => d.label.substring(0, 4))
        .attr('text-anchor', 'middle')
        .attr('dy', 4)
        .attr('fill', 'white')
        .attr('font-size', '10px')
        .attr('font-weight', '600');

    node.append('title')
        .text(d => `${d.label}\nType: ${d.type}\nStatus: ${d.status}`);

    simulation.on('tick', () => {
        data.nodes.forEach(d => {
            d.x = Math.max(30, Math.min(width - 30, d.x));
            d.y = Math.max(30, Math.min(height - 30, d.y));
        });

        link.attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }
}

async function loadMetrics() {
    const latencyContainer = document.getElementById('latencyChart')?.parentElement;
    const throughputContainer = document.getElementById('throughputChart')?.parentElement;
    const errorContainer = document.getElementById('errorChart')?.parentElement;

    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('[Unified] Chart.js is not loaded');
        const errorHtml = `
            <div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <i data-lucide="alert-circle" style="width: 32px; height: 32px; color: var(--color-warning);"></i>
                <p class="text-muted text-sm mt-2">Chart library not loaded</p>
            </div>
        `;
        if (latencyContainer) latencyContainer.innerHTML = errorHtml;
        if (throughputContainer) throughputContainer.innerHTML = errorHtml;
        if (errorContainer) errorContainer.innerHTML = errorHtml;
        lucide.createIcons();
        return;
    }

    try {
        const chartOptions = (unit) => ({
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } },
                y: { grid: { color: '#e2e8f0' }, ticks: { color: '#64748b', callback: v => v + unit } }
            }
        });

        const labels = generateLabels(24);

        // Latency
        if (charts.latency) charts.latency.destroy();
        charts.latency = new Chart(document.getElementById('latencyChart').getContext('2d'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    data: generateData(24, 80, 150),
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: chartOptions('ms')
        });

        // Throughput
        if (charts.throughput) charts.throughput.destroy();
        charts.throughput = new Chart(document.getElementById('throughputChart').getContext('2d'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    data: generateData(24, 800, 1500),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: chartOptions('/s')
        });

        // Error Rate
        if (charts.error) charts.error.destroy();
        charts.error = new Chart(document.getElementById('errorChart').getContext('2d'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    data: generateData(24, 0.1, 1.5),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: chartOptions('%')
        });

        console.log('[Unified] Metrics charts rendered successfully');
    } catch (error) {
        console.error('[Unified] Error rendering metrics charts:', error);
        const errorHtml = `
            <div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <i data-lucide="alert-circle" style="width: 32px; height: 32px; color: var(--color-warning);"></i>
                <p class="text-muted text-sm mt-2">Error loading chart</p>
            </div>
        `;
        if (latencyContainer) latencyContainer.innerHTML = errorHtml;
        if (throughputContainer) throughputContainer.innerHTML = errorHtml;
        if (errorContainer) errorContainer.innerHTML = errorHtml;
        lucide.createIcons();
    }
}

async function loadCosts() {
    const chartContainer = document.getElementById('costChart')?.parentElement;
    const detailsContainer = document.getElementById('costDetails');

    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('[Unified] Chart.js is not loaded for costs');
        if (chartContainer) chartContainer.innerHTML = `<div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center;"><p class="text-muted">Chart library not loaded</p></div>`;
        if (detailsContainer) detailsContainer.innerHTML = '';
        return;
    }

    try {
        console.log('[Unified] Fetching costs data...');
        const response = await fetch('/api/dashboard/costs');
        const result = await response.json();
        console.log('[Unified] Costs API response:', result);

        if (result.success && result.data && result.data.by_category && Object.keys(result.data.by_category).length > 0) {
            const data = result.data;

            if (charts.cost) charts.cost.destroy();
            charts.cost = new Chart(document.getElementById('costChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.by_category),
                    datasets: [{
                        data: Object.values(data.by_category),
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: { legend: { display: false } }
                }
            });

            detailsContainer.innerHTML = `
                <div class="mb-4">
                    <div class="text-sm text-muted">Total (30d)</div>
                    <div class="kpi-value">$${(data.total || 0).toLocaleString()}</div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-muted">Forecast</div>
                    <div class="font-semibold" style="font-size: 1.25rem;">$${(data.forecast_next_month || 0).toLocaleString()}</div>
                </div>
                <div class="kpi-trend ${data.trend || 'stable'}">
                    <i data-lucide="trending-${data.trend || 'up'}"></i>
                    <span>${data.trend_pct || 0}% vs last period</span>
                </div>
            `;
            lucide.createIcons();
        } else {
            chartContainer.innerHTML = `
                <div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <i data-lucide="dollar-sign" style="width: 32px; height: 32px; color: var(--text-muted);"></i>
                    <p class="text-muted text-sm mt-2">No cost data available</p>
                </div>
            `;
            detailsContainer.innerHTML = `
                <div class="text-muted text-sm">Cost data will appear here when available</div>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading costs:', error);
        chartContainer.innerHTML = `
            <div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <i data-lucide="alert-circle" style="width: 32px; height: 32px; color: var(--color-warning);"></i>
                <p class="text-muted text-sm mt-2">Error loading cost data</p>
            </div>
        `;
        detailsContainer.innerHTML = `<div class="text-muted text-sm">Unable to load cost details</div>`;
        lucide.createIcons();
    }
}

async function loadCarbon() {
    const chartContainer = document.getElementById('carbonChart')?.parentElement;
    const detailsContainer = document.getElementById('carbonDetails');

    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('[Unified] Chart.js is not loaded for carbon');
        if (chartContainer) chartContainer.innerHTML = `<div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center;"><p class="text-muted">Chart library not loaded</p></div>`;
        if (detailsContainer) detailsContainer.innerHTML = '';
        return;
    }

    try {
        console.log('[Unified] Fetching carbon data...');
        const response = await fetch('/api/dashboard/carbon');
        const result = await response.json();
        console.log('[Unified] Carbon API response:', result);

        if (result.success && result.data && result.data.by_activity && Object.keys(result.data.by_activity).length > 0) {
            const data = result.data;

            if (charts.carbon) charts.carbon.destroy();
            charts.carbon = new Chart(document.getElementById('carbonChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.by_activity),
                    datasets: [{
                        data: Object.values(data.by_activity),
                        backgroundColor: ['#10b981', '#22c55e', '#4ade80', '#86efac'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: { legend: { display: false } }
                }
            });

            detailsContainer.innerHTML = `
                <div class="mb-4">
                    <div class="text-sm text-muted">Total (30d)</div>
                    <div class="kpi-value">${(data.total_carbon_kg || 0).toLocaleString()} kg</div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-muted">Green Energy</div>
                    <div class="font-semibold" style="font-size: 1.25rem; color: var(--color-success);">${data.green_energy_pct || 0}%</div>
                </div>
                <div class="kpi-trend ${data.trend || 'stable'}">
                    <i data-lucide="trending-${data.trend || 'down'}"></i>
                    <span>${data.trend_pct || 0}% vs last period</span>
                </div>
            `;
            lucide.createIcons();
        } else {
            chartContainer.innerHTML = `
                <div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <i data-lucide="leaf" style="width: 32px; height: 32px; color: var(--text-muted);"></i>
                    <p class="text-muted text-sm mt-2">No carbon data available</p>
                </div>
            `;
            detailsContainer.innerHTML = `
                <div class="text-muted text-sm">Carbon metrics will appear here when available</div>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading carbon:', error);
        chartContainer.innerHTML = `
            <div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <i data-lucide="alert-circle" style="width: 32px; height: 32px; color: var(--color-warning);"></i>
                <p class="text-muted text-sm mt-2">Error loading carbon data</p>
            </div>
        `;
        detailsContainer.innerHTML = `<div class="text-muted text-sm">Unable to load carbon details</div>`;
        lucide.createIcons();
    }
}

async function loadSLO() {
    const overallContainer = document.getElementById('sloOverall');
    const gridContainer = document.getElementById('sloGrid');

    try {
        console.log('[Unified] Fetching SLO data...');
        const response = await fetch('/api/dashboard/slo');
        const result = await response.json();
        console.log('[Unified] SLO API response:', result);

        if (result.success && result.data && result.data.slos && result.data.slos.length > 0) {
            const data = result.data;

            overallContainer.innerHTML = `
                <span class="badge-dot"></span>
                ${data.overall_compliance_pct || 0}% Compliant
            `;

            gridContainer.innerHTML = data.slos.map(slo => `
                <div class="card" style="padding: 1rem;">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-sm">${slo.name || 'SLO'}</span>
                        <span class="badge badge-${slo.status || 'healthy'}">${slo.status || 'unknown'}</span>
                    </div>
                    <div class="kpi-value" style="font-size: 1.5rem;">${slo.current || 0}${slo.unit || ''}</div>
                    <div class="mt-4">
                        <div style="height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${slo.error_budget_remaining_pct || 0}%; background: ${(slo.error_budget_remaining_pct || 0) > 50 ? 'var(--color-success)' : (slo.error_budget_remaining_pct || 0) > 20 ? 'var(--color-warning)' : 'var(--color-danger)'}; border-radius: 3px;"></div>
                        </div>
                        <div class="text-xs text-muted mt-1">Error budget: ${slo.error_budget_remaining_pct || 0}% remaining</div>
                    </div>
                </div>
            `).join('');
        } else {
            overallContainer.innerHTML = `
                <span class="badge-dot"></span>
                No data
            `;
            overallContainer.className = 'badge badge-warning';
            gridContainer.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1; padding: 2rem; text-align: center;">
                    <i data-lucide="target" style="width: 32px; height: 32px; color: var(--text-muted); margin: 0 auto;"></i>
                    <p class="text-muted text-sm mt-2">No SLO data available</p>
                </div>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading SLO:', error);
        overallContainer.innerHTML = `
            <span class="badge-dot"></span>
            Error
        `;
        overallContainer.className = 'badge badge-warning';
        gridContainer.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; padding: 2rem; text-align: center;">
                <i data-lucide="alert-circle" style="width: 32px; height: 32px; color: var(--color-warning); margin: 0 auto;"></i>
                <p class="text-muted text-sm mt-2">Error loading SLO data</p>
            </div>
        `;
        lucide.createIcons();
    }
}

async function loadCompliance() {
    const gridContainer = document.getElementById('complianceGrid');

    try {
        console.log('[Unified] Fetching compliance data...');
        const response = await fetch('/api/dashboard/compliance');
        const result = await response.json();
        console.log('[Unified] Compliance API response:', result);

        if (result.success && result.data && result.data.categories && Object.keys(result.data.categories).length > 0) {
            const data = result.data;

            gridContainer.innerHTML = Object.entries(data.categories).map(([key, cat]) => `
                <div class="card text-center" style="padding: 1rem;">
                    <div class="kpi-value" style="color: ${(cat.status || 'warning') === 'compliant' ? 'var(--color-success)' : 'var(--color-warning)'};">
                        ${cat.score || 0}
                    </div>
                    <div class="text-sm text-muted mb-2">${key.replace(/_/g, ' ')}</div>
                    <span class="badge badge-${(cat.status || 'warning') === 'compliant' ? 'healthy' : 'warning'}">
                        ${cat.status || 'unknown'}
                    </span>
                </div>
            `).join('');
        } else {
            gridContainer.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1; padding: 2rem; text-align: center;">
                    <i data-lucide="shield" style="width: 32px; height: 32px; color: var(--text-muted); margin: 0 auto;"></i>
                    <p class="text-muted text-sm mt-2">No compliance data available</p>
                </div>
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading compliance:', error);
        gridContainer.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; padding: 2rem; text-align: center;">
                <i data-lucide="alert-circle" style="width: 32px; height: 32px; color: var(--color-warning); margin: 0 auto;"></i>
                <p class="text-muted text-sm mt-2">Error loading compliance data</p>
            </div>
        `;
        lucide.createIcons();
    }
}

function generateLabels(count) {
    const labels = [];
    const now = new Date();
    for (let i = count; i >= 0; i--) {
        const d = new Date(now - i * 3600000);
        labels.push(d.getHours() + ':00');
    }
    return labels;
}

function generateData(count, min, max) {
    const data = [];
    let value = (min + max) / 2;
    for (let i = 0; i < count; i++) {
        value += (Math.random() - 0.5) * (max - min) * 0.2;
        value = Math.max(min, Math.min(max, value));
        data.push(parseFloat(value.toFixed(2)));
    }
    return data;
}
</script>
{% endblock %}
