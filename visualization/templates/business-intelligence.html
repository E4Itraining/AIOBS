{% extends "base.html" %}

{% set active_page = 'business-intelligence' %}

{% block page_title %}BI{% endblock %}
{% block page_subtitle %}<p class="text-muted">KPIs, revenue attribution, ROI analysis, and executive dashboards</p>{% endblock %}

{% block topbar_actions %}
<button class="btn btn-secondary" onclick="runSimulation()">
    <i data-lucide="play"></i>
    Run Simulation
</button>
<button class="btn btn-primary" onclick="exportReport()">
    <i data-lucide="download"></i>
    Export Report
</button>
{% endblock %}

{% block content %}
<!-- Executive Summary -->
<div class="bi-hero">
    <div class="kpi-cards-grid">
        <div class="kpi-card">
            <div class="kpi-header">
                <span class="kpi-title">AI Revenue Impact</span>
                <span class="kpi-trend up"><i data-lucide="trending-up"></i> +12%</span>
            </div>
            <span class="kpi-value">$2.4M</span>
            <span class="kpi-period">This Quarter</span>
            <div class="kpi-chart">
                <canvas id="revenueSparkline" height="40"></canvas>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <span class="kpi-title">Cost Efficiency</span>
                <span class="kpi-trend up"><i data-lucide="trending-up"></i> +8%</span>
            </div>
            <span class="kpi-value">3.2x</span>
            <span class="kpi-period">ROI Multiplier</span>
            <div class="kpi-chart">
                <canvas id="roiSparkline" height="40"></canvas>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <span class="kpi-title">Operational Savings</span>
                <span class="kpi-trend up"><i data-lucide="trending-up"></i> +23%</span>
            </div>
            <span class="kpi-value">$890K</span>
            <span class="kpi-period">Annual Savings</span>
            <div class="kpi-chart">
                <canvas id="savingsSparkline" height="40"></canvas>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <span class="kpi-title">Model Efficiency</span>
                <span class="kpi-trend down"><i data-lucide="trending-down"></i> -2%</span>
            </div>
            <span class="kpi-value">94.2%</span>
            <span class="kpi-period">Avg Accuracy</span>
            <div class="kpi-chart">
                <canvas id="accuracySparkline" height="40"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Revenue Attribution & Cost-Benefit -->
<section class="mb-6">
    <div class="grid grid-2">
        <!-- Revenue Attribution -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Revenue Attribution by Model</h3>
            </div>
            <div class="chart-container" style="height: 250px;">
                <canvas id="revenueAttribution"></canvas>
            </div>
            <div class="attribution-list">
                <div class="attribution-item">
                    <span class="attribution-model">Recommendation Engine</span>
                    <span class="attribution-value">$1.2M</span>
                    <span class="attribution-percent">50%</span>
                </div>
                <div class="attribution-item">
                    <span class="attribution-model">Fraud Detection</span>
                    <span class="attribution-value">$680K</span>
                    <span class="attribution-percent">28%</span>
                </div>
                <div class="attribution-item">
                    <span class="attribution-model">Customer Support AI</span>
                    <span class="attribution-value">$520K</span>
                    <span class="attribution-percent">22%</span>
                </div>
            </div>
        </div>

        <!-- Cost-Benefit Analysis -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Cost-Benefit Analysis</h3>
            </div>
            <div class="cost-benefit-summary">
                <div class="cb-metric positive">
                    <span class="cb-label">Total Benefits</span>
                    <span class="cb-value">$3.2M</span>
                </div>
                <div class="cb-metric negative">
                    <span class="cb-label">Total Costs</span>
                    <span class="cb-value">$980K</span>
                </div>
                <div class="cb-metric net">
                    <span class="cb-label">Net Value</span>
                    <span class="cb-value">$2.22M</span>
                </div>
            </div>
            <div class="chart-container" style="height: 180px;">
                <canvas id="costBenefitChart"></canvas>
            </div>
        </div>
    </div>
</section>

<!-- KPI Dashboard -->
<section class="mb-6">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Key Performance Indicators</h3>
            <div class="header-actions">
                <select class="form-select" style="width: 150px;">
                    <option>All Categories</option>
                    <option>Financial</option>
                    <option>Operational</option>
                    <option>Quality</option>
                </select>
            </div>
        </div>
        <div class="kpis-grid">
            <div class="kpi-tile on-track">
                <div class="kpi-tile-header">
                    <span class="kpi-category">Financial</span>
                    <span class="kpi-status on-track">On Track</span>
                </div>
                <span class="kpi-tile-name">Customer Acquisition Cost</span>
                <div class="kpi-tile-values">
                    <span class="current">$45</span>
                    <span class="target">Target: $50</span>
                </div>
                <div class="kpi-progress">
                    <div class="progress-bar" style="width: 90%"></div>
                </div>
            </div>

            <div class="kpi-tile on-track">
                <div class="kpi-tile-header">
                    <span class="kpi-category">Operational</span>
                    <span class="kpi-status on-track">On Track</span>
                </div>
                <span class="kpi-tile-name">Model Uptime</span>
                <div class="kpi-tile-values">
                    <span class="current">99.95%</span>
                    <span class="target">Target: 99.9%</span>
                </div>
                <div class="kpi-progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="kpi-tile at-risk">
                <div class="kpi-tile-header">
                    <span class="kpi-category">Quality</span>
                    <span class="kpi-status at-risk">At Risk</span>
                </div>
                <span class="kpi-tile-name">Customer Satisfaction</span>
                <div class="kpi-tile-values">
                    <span class="current">4.2</span>
                    <span class="target">Target: 4.5</span>
                </div>
                <div class="kpi-progress at-risk">
                    <div class="progress-bar" style="width: 84%"></div>
                </div>
            </div>

            <div class="kpi-tile on-track">
                <div class="kpi-tile-header">
                    <span class="kpi-category">Financial</span>
                    <span class="kpi-status on-track">On Track</span>
                </div>
                <span class="kpi-tile-name">Revenue per Model</span>
                <div class="kpi-tile-values">
                    <span class="current">$180K</span>
                    <span class="target">Target: $150K</span>
                </div>
                <div class="kpi-progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="kpi-tile off-track">
                <div class="kpi-tile-header">
                    <span class="kpi-category">Operational</span>
                    <span class="kpi-status off-track">Off Track</span>
                </div>
                <span class="kpi-tile-name">Response Time (P95)</span>
                <div class="kpi-tile-values">
                    <span class="current">850ms</span>
                    <span class="target">Target: 500ms</span>
                </div>
                <div class="kpi-progress off-track">
                    <div class="progress-bar" style="width: 59%"></div>
                </div>
            </div>

            <div class="kpi-tile on-track">
                <div class="kpi-tile-header">
                    <span class="kpi-category">Quality</span>
                    <span class="kpi-status on-track">On Track</span>
                </div>
                <span class="kpi-tile-name">Model Accuracy</span>
                <div class="kpi-tile-values">
                    <span class="current">94.2%</span>
                    <span class="target">Target: 92%</span>
                </div>
                <div class="kpi-progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Impact Simulation -->
<section class="mb-6">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Impact Simulation</h3>
            <button class="btn btn-sm btn-secondary" onclick="runSimulation()">
                <i data-lucide="play"></i>
                New Simulation
            </button>
        </div>
        <div class="simulation-container">
            <div class="simulation-scenario">
                <h4>Scenario: Scale Recommendation Engine</h4>
                <p>What if we increase the recommendation model capacity by 50%?</p>
            </div>
            <div class="simulation-results">
                <div class="result-item positive">
                    <i data-lucide="trending-up"></i>
                    <div class="result-content">
                        <span class="result-metric">Projected Revenue</span>
                        <span class="result-value">+$450K/quarter</span>
                    </div>
                </div>
                <div class="result-item negative">
                    <i data-lucide="coins"></i>
                    <div class="result-content">
                        <span class="result-metric">Infrastructure Cost</span>
                        <span class="result-value">+$85K/quarter</span>
                    </div>
                </div>
                <div class="result-item positive">
                    <i data-lucide="percent"></i>
                    <div class="result-content">
                        <span class="result-metric">Net ROI</span>
                        <span class="result-value">429%</span>
                    </div>
                </div>
                <div class="result-item neutral">
                    <i data-lucide="clock"></i>
                    <div class="result-content">
                        <span class="result-metric">Payback Period</span>
                        <span class="result-value">2.3 months</span>
                    </div>
                </div>
            </div>
            <div class="simulation-confidence">
                <span>Confidence Level: <strong>82%</strong></span>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: 82%"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.section-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: var(--space-4);
}

/* BI Hero */
.bi-hero {
    margin-bottom: var(--space-6);
}

.kpi-cards-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
}

.kpi-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--space-4);
}

.kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.kpi-title {
    font-size: 0.8125rem;
    color: var(--text-secondary);
}

.kpi-trend {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.75rem;
    font-weight: 600;
}

.kpi-trend.up {
    color: var(--color-success);
}

.kpi-trend.down {
    color: var(--color-danger);
}

.kpi-trend svg {
    width: 14px;
    height: 14px;
}

.kpi-value {
    display: block;
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: var(--space-1);
}

.kpi-period {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.kpi-chart {
    margin-top: var(--space-3);
}

/* Attribution List */
.attribution-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-color);
}

.attribution-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.attribution-model {
    flex: 1;
    font-size: 0.8125rem;
}

.attribution-value {
    font-weight: 600;
    font-size: 0.875rem;
}

.attribution-percent {
    width: 40px;
    text-align: right;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Cost-Benefit Summary */
.cost-benefit-summary {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
}

.cb-metric {
    flex: 1;
    padding: var(--space-3);
    border-radius: var(--radius-lg);
    text-align: center;
}

.cb-metric.positive {
    background: var(--color-success-light);
}

.cb-metric.negative {
    background: var(--color-danger-light);
}

.cb-metric.net {
    background: var(--color-primary-light);
}

.cb-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-1);
}

.cb-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.cb-metric.positive .cb-value { color: var(--color-success); }
.cb-metric.negative .cb-value { color: var(--color-danger); }
.cb-metric.net .cb-value { color: var(--color-primary); }

/* KPIs Grid */
.kpis-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
}

.kpi-tile {
    padding: var(--space-4);
    background: var(--bg-hover);
    border-radius: var(--radius-lg);
    border-left: 3px solid var(--color-success);
}

.kpi-tile.at-risk {
    border-left-color: var(--color-warning);
}

.kpi-tile.off-track {
    border-left-color: var(--color-danger);
}

.kpi-tile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.kpi-category {
    font-size: 0.6875rem;
    text-transform: uppercase;
    color: var(--text-secondary);
}

.kpi-status {
    font-size: 0.6875rem;
    font-weight: 600;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
}

.kpi-status.on-track {
    background: var(--color-success-light);
    color: var(--color-success);
}

.kpi-status.at-risk {
    background: var(--color-warning-light);
    color: var(--color-warning);
}

.kpi-status.off-track {
    background: var(--color-danger-light);
    color: var(--color-danger);
}

.kpi-tile-name {
    display: block;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: var(--space-3);
}

.kpi-tile-values {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--space-2);
}

.kpi-tile-values .current {
    font-size: 1.25rem;
    font-weight: 700;
}

.kpi-tile-values .target {
    font-size: 0.75rem;
    color: var(--text-secondary);
    align-self: flex-end;
}

.kpi-progress {
    height: 4px;
    background: var(--border-color);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.kpi-progress .progress-bar {
    height: 100%;
    background: var(--color-success);
    border-radius: var(--radius-full);
}

.kpi-progress.at-risk .progress-bar {
    background: var(--color-warning);
}

.kpi-progress.off-track .progress-bar {
    background: var(--color-danger);
}

/* Simulation Container */
.simulation-container {
    padding: var(--space-4);
    background: var(--bg-hover);
    border-radius: var(--radius-lg);
}

.simulation-scenario {
    margin-bottom: var(--space-4);
}

.simulation-scenario h4 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: var(--space-2);
}

.simulation-scenario p {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.simulation-results {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-4);
}

.result-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--bg-card);
    border-radius: var(--radius-lg);
}

.result-item svg {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
}

.result-item.positive svg { color: var(--color-success); }
.result-item.negative svg { color: var(--color-danger); }
.result-item.neutral svg { color: var(--color-primary); }

.result-metric {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.result-value {
    font-weight: 700;
    font-size: 1rem;
}

.result-item.positive .result-value { color: var(--color-success); }
.result-item.negative .result-value { color: var(--color-danger); }

.simulation-confidence {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: 0.8125rem;
}

.confidence-bar {
    flex: 1;
    height: 8px;
    background: var(--border-color);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    background: var(--color-primary);
    border-radius: var(--radius-full);
}

.header-actions {
    display: flex;
    gap: var(--space-2);
}

@media (max-width: 1200px) {
    .kpi-cards-grid,
    .simulation-results {
        grid-template-columns: repeat(2, 1fr);
    }

    .kpis-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .kpi-cards-grid,
    .simulation-results,
    .kpis-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    await loadBIData();
    initCharts();
    lucide.createIcons();
});

async function loadBIData() {
    try {
        const response = await fetch('/api/business-intelligence/analytics');
        const result = await response.json();
        if (result.success) {
            console.log('BI data loaded:', result.data);
        }
    } catch (error) {
        console.error('Error loading BI data:', error);
    }
}

function initCharts() {
    // Revenue Attribution Chart
    const revenueCtx = document.getElementById('revenueAttribution');
    if (revenueCtx) {
        new Chart(revenueCtx, {
            type: 'doughnut',
            data: {
                labels: ['Recommendation', 'Fraud Detection', 'Support AI'],
                datasets: [{
                    data: [50, 28, 22],
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Cost-Benefit Chart
    const cbCtx = document.getElementById('costBenefitChart');
    if (cbCtx) {
        new Chart(cbCtx, {
            type: 'bar',
            data: {
                labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                datasets: [{
                    label: 'Benefits',
                    data: [700, 850, 820, 830],
                    backgroundColor: '#10b981'
                }, {
                    label: 'Costs',
                    data: [220, 240, 260, 260],
                    backgroundColor: '#ef4444'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => '$' + value + 'K'
                        }
                    }
                }
            }
        });
    }

    // Sparklines
    initSparkline('revenueSparkline', [2.1, 2.2, 2.0, 2.3, 2.4], '#10b981');
    initSparkline('roiSparkline', [2.8, 2.9, 3.0, 3.1, 3.2], '#6366f1');
    initSparkline('savingsSparkline', [720, 780, 820, 850, 890], '#f59e0b');
    initSparkline('accuracySparkline', [95.1, 94.8, 94.5, 94.3, 94.2], '#8b5cf6');
}

function initSparkline(id, data, color) {
    const ctx = document.getElementById(id);
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => i),
                datasets: [{
                    data: data,
                    borderColor: color,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
    }
}

function runSimulation() {
    showToast('Opening simulation wizard...', 'info');
}

function exportReport() {
    showToast('Generating executive report...', 'info');
    setTimeout(() => {
        showToast('Report exported successfully!', 'success');
    }, 2000);
}
</script>
{% endblock %}
