{% extends "base.html" %}

{% set active_page = 'dashboard' %}

{% block page_title %}{{ t('dashboard.title') }}{% endblock %}

{% block page_subtitle %}
<p>{{ t('dashboard.subtitle') or 'AI Trust Control Layer - Overview' }}</p>
{% endblock %}

{% block topbar_actions %}
<div class="profile-selector" id="profileSelector">
    <button class="btn btn-secondary" data-profile="all">
        <i data-lucide="users"></i>
        <span>All Profiles</span>
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Page Narrative Section -->
<div class="page-narrative" id="pageNarrative">
    <button class="narrative-dismiss" onclick="dismissNarrative()" title="{{ t('actions.close') or 'Close' }}">
        <i data-lucide="x"></i>
    </button>
    <div class="narrative-header">
        <div class="narrative-icon">
            <i data-lucide="eye"></i>
        </div>
        <div class="narrative-content">
            <h2>{{ t('narrative.dashboard_title') or 'Bienvenue dans votre Centre de Contrôle IA' }}</h2>
            <p>{{ t('narrative.dashboard_desc') or 'GASKIA vous offre une vision unifiée de vos systèmes IA : fiabilité, performance, coûts et conformité. Voir. Prouver. Maîtriser.' }}</p>
        </div>
    </div>
    <div class="narrative-features">
        <div class="narrative-feature">
            <i data-lucide="shield-check"></i>
            <span>Score de Confiance</span>
        </div>
        <div class="narrative-feature">
            <i data-lucide="activity"></i>
            <span>Monitoring Live</span>
        </div>
        <div class="narrative-feature">
            <i data-lucide="git-branch"></i>
            <span>Analyse Causale</span>
        </div>
        <div class="narrative-feature">
            <i data-lucide="shield"></i>
            <span>Conformité IA</span>
        </div>
    </div>
    <div class="narrative-actions">
        <button class="btn btn-primary" onclick="startGuidedTour()">
            <i data-lucide="play-circle"></i>
            {{ t('help.start_tour') or 'Découvrir en 2 minutes' }}
        </button>
        <a href="/personas" class="btn btn-secondary">
            <i data-lucide="compass"></i>
            {{ t('help.change_profile') or 'Choisir mon Parcours' }}
        </a>
    </div>
</div>

<!-- Quick Tips for New Users -->
<div class="quick-tips" id="quickTips">
    <div class="quick-tips-header">
        <i data-lucide="sparkles"></i>
        {{ t('help.quick_tips') or 'Astuces Rapides' }}
        <button class="quick-tips-dismiss" onclick="dismissTips()" title="Fermer">
            <i data-lucide="x"></i>
        </button>
    </div>
    <div class="quick-tips-grid">
        <div class="quick-tip">
            <div class="quick-tip-icon"><i data-lucide="mouse-pointer-click"></i></div>
            <div class="quick-tip-content">
                <strong>{{ t('help.tip_1_title') or 'KPIs Interactifs' }}</strong>
                <span>{{ t('help.tip_1') or 'Cliquez sur une carte KPI pour voir les détails et tendances' }}</span>
            </div>
        </div>
        <div class="quick-tip">
            <div class="quick-tip-icon"><i data-lucide="command"></i></div>
            <div class="quick-tip-content">
                <strong>{{ t('help.tip_2_title') or 'Navigation Rapide' }}</strong>
                <span>{{ t('help.tip_2') or 'Utilisez ⌘K pour accéder instantanément à n\'importe quelle page' }}</span>
            </div>
        </div>
        <div class="quick-tip">
            <div class="quick-tip-icon"><i data-lucide="search"></i></div>
            <div class="quick-tip-content">
                <strong>{{ t('help.tip_3_title') or 'Analyse Causale' }}</strong>
                <span>{{ t('help.tip_3') or 'Cliquez "Investiguer" sur un problème pour voir l\'analyse root cause' }}</span>
            </div>
        </div>
        <div class="quick-tip">
            <div class="quick-tip-icon"><i data-lucide="message-circle"></i></div>
            <div class="quick-tip-content">
                <strong>{{ t('help.tip_4_title') or 'Assistant IA' }}</strong>
                <span>{{ t('help.tip_4') or 'Posez vos questions à l\'assistant en bas à droite' }}</span>
            </div>
        </div>
    </div>
</div>

<!-- KPI Grid -->
<div class="kpi-grid">
    <div class="kpi-card" id="kpiTrust">
        <div class="kpi-icon primary">
            <i data-lucide="shield-check"></i>
        </div>
        <div class="kpi-label">{{ t('dashboard.trust_score') }}</div>
        <div class="kpi-value" id="trustScore">
            <span class="skeleton" style="display: inline-block; width: 80px; height: 32px;"></span>
        </div>
        <div class="kpi-trend stable" id="trustTrend">
            <i data-lucide="minus"></i>
            <span>{{ t('trends.stable') }}</span>
        </div>
    </div>

    <div class="kpi-card" id="kpiInferences">
        <div class="kpi-icon success">
            <i data-lucide="zap"></i>
        </div>
        <div class="kpi-label">{{ t('dashboard.daily_inferences') }}</div>
        <div class="kpi-value" id="inferences">
            <span class="skeleton" style="display: inline-block; width: 80px; height: 32px;"></span>
        </div>
        <div class="kpi-trend up">
            <i data-lucide="trending-up"></i>
            <span>+12%</span>
        </div>
    </div>

    <div class="kpi-card" id="kpiCost">
        <div class="kpi-icon warning">
            <i data-lucide="dollar-sign"></i>
        </div>
        <div class="kpi-label">{{ t('dashboard.daily_cost') }}</div>
        <div class="kpi-value" id="dailyCost">
            <span class="skeleton" style="display: inline-block; width: 80px; height: 32px;"></span>
        </div>
        <div class="kpi-trend" id="costTrend">
            <i data-lucide="trending-up"></i>
            <span>+8%</span>
        </div>
    </div>

    <div class="kpi-card" id="kpiCarbon">
        <div class="kpi-icon danger">
            <i data-lucide="leaf"></i>
        </div>
        <div class="kpi-label">{{ t('dashboard.carbon_footprint') }}</div>
        <div class="kpi-value" id="carbonKg">
            <span class="skeleton" style="display: inline-block; width: 80px; height: 32px;"></span>
        </div>
        <div class="kpi-trend down" id="carbonTrend">
            <i data-lucide="trending-down"></i>
            <span>-5%</span>
        </div>
    </div>
</div>

<!-- Health & Alerts Row -->
<div class="grid grid-2 mb-6">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ t('dashboard.system_health') }}</h3>
        </div>
        <div class="flex justify-between" style="text-align: center;">
            <div style="flex: 1;">
                <div class="kpi-value" style="color: var(--color-success);" id="healthyCount">--</div>
                <div class="text-sm text-muted">{{ t('dashboard.healthy') }}</div>
            </div>
            <div style="flex: 1;">
                <div class="kpi-value" style="color: var(--color-warning);" id="degradedCount">--</div>
                <div class="text-sm text-muted">{{ t('dashboard.degraded') }}</div>
            </div>
            <div style="flex: 1;">
                <div class="kpi-value" style="color: var(--color-danger);" id="unhealthyCount">--</div>
                <div class="text-sm text-muted">{{ t('dashboard.unhealthy') }}</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ t('dashboard.active_alerts') }}</h3>
        </div>
        <div class="flex justify-between" style="text-align: center;">
            <div style="flex: 1;">
                <div class="kpi-value" style="color: var(--color-danger);" id="criticalAlerts">--</div>
                <div class="text-sm text-muted">{{ t('dashboard.critical') }}</div>
            </div>
            <div style="flex: 1;">
                <div class="kpi-value" style="color: var(--color-warning);" id="warningAlerts">--</div>
                <div class="text-sm text-muted">{{ t('dashboard.warning') }}</div>
            </div>
            <div style="flex: 1;">
                <div class="kpi-value" style="color: var(--color-info);" id="infoAlerts">--</div>
                <div class="text-sm text-muted">{{ t('dashboard.info') }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-2 mb-6">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ t('dashboard.trust_score_trend') }}</h3>
            <select id="chartTimeRange" class="form-select" style="width: auto;">
                <option value="24">{{ t('time.last_24h') }}</option>
                <option value="168">{{ t('time.last_7d') }}</option>
                <option value="720">{{ t('time.last_30d') }}</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="trustChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ t('dashboard.slo_compliance') }}</h3>
        </div>
        <div class="chart-container">
            <canvas id="sloChart"></canvas>
        </div>
    </div>
</div>

<!-- Services Table -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">{{ t('dashboard.services_status') }}</h3>
        <div class="flex gap-2">
            <input type="search"
                   id="serviceSearch"
                   class="form-input"
                   placeholder="{{ t('dashboard.search_services') }}"
                   style="width: 200px;">
        </div>
    </div>
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>{{ t('table.service') }}</th>
                    <th>{{ t('table.type') }}</th>
                    <th>{{ t('table.status') }}</th>
                    <th>{{ t('table.uptime') }}</th>
                    <th>{{ t('table.error_rate') }}</th>
                    <th>{{ t('table.latency_p99') }}</th>
                </tr>
            </thead>
            <tbody id="servicesTableBody">
                <tr>
                    <td colspan="6">
                        <div class="loader"><div class="spinner"></div></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Top Issues -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">{{ t('dashboard.top_issues') }}</h3>
    </div>
    <div id="topIssues">
        <div class="loader"><div class="spinner"></div></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let trustChart = null;
let sloChart = null;

// Dashboard real-time updater instance
let dashboardUpdater = null;

document.addEventListener('DOMContentLoaded', async () => {
    // Initialize loading states
    showLoadingStates();

    // Load initial data with proper error handling
    const loadResults = await Promise.allSettled([
        loadProfiles(),
        loadDashboardData(),
        loadServices()
    ]);

    // Check for failures and show appropriate messages
    loadResults.forEach((result, index) => {
        if (result.status === 'rejected') {
            const names = ['profiles', 'dashboard', 'services'];
            console.error(`Failed to load ${names[index]}:`, result.reason);
        }
    });

    initCharts();
    lucide.createIcons();

    // Set up real-time updates
    setupRealtimeUpdates();
});

// Show loading indicators
function showLoadingStates() {
    ['trustScore', 'inferences', 'dailyCost', 'carbonKg'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.innerHTML = '<span class="skeleton" style="display: inline-block; width: 60px; height: 24px;"></span>';
        }
    });
}

// Set up real-time updates for dashboard
function setupRealtimeUpdates() {
    dashboardUpdater = new window.aiobs.RealtimeUpdater({
        interval: 30000, // 30 seconds default
        maxErrors: 5,
        onStatusChange: (status) => {
            updateConnectionStatus(status);
        }
    });

    // Subscribe to dashboard overview updates
    dashboardUpdater.subscribe('dashboard', '/api/dashboard/overview', (data) => {
        if (data && data.key_metrics) {
            updateKPI('trustScore', (data.key_metrics.avg_trust_score * 100).toFixed(0) + '%');
            updateKPI('inferences', formatNumber(data.key_metrics.total_daily_inferences));
            updateKPI('dailyCost', '$' + data.key_metrics.total_daily_cost.toFixed(0));
            updateKPI('carbonKg', data.key_metrics.total_daily_carbon_kg.toFixed(1) + ' kg');

            if (data.health) {
                document.getElementById('healthyCount').textContent = data.health.healthy;
                document.getElementById('degradedCount').textContent = data.health.degraded;
                document.getElementById('unhealthyCount').textContent = data.health.unhealthy;
            }

            if (data.alerts) {
                document.getElementById('criticalAlerts').textContent = data.alerts.critical;
                document.getElementById('warningAlerts').textContent = data.alerts.warning;
                document.getElementById('infoAlerts').textContent = data.alerts.info;
            }

            if (data.trends) {
                updateTrend('trustTrend', data.trends.trust);
                updateTrend('costTrend', data.trends.cost);
                updateTrend('carbonTrend', data.trends.carbon);
            }

            if (data.top_issues) {
                updateTopIssues(data.top_issues);
            }
        }
    }, {
        interval: 30000,
        immediate: false, // Already loaded initially
        onError: (error, count) => {
            if (count >= 3) {
                showToast(t('errors.connection') || 'Connexion interrompue. Réessai en cours...', 'warning');
            }
        }
    });

    // Subscribe to services updates (less frequent)
    dashboardUpdater.subscribe('services', '/api/dashboard/services', (data) => {
        if (data) {
            renderServicesTable(data);
        }
    }, {
        interval: 60000, // 1 minute
        immediate: false
    });

    // Pause updates when page is hidden
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            dashboardUpdater.pause();
        } else {
            dashboardUpdater.resume();
        }
    });
}

// Update connection status indicator
function updateConnectionStatus(status) {
    // Could add a visual indicator here if desired
    console.log('Connection status:', status);
}

// Load profiles
async function loadProfiles() {
    try {
        const response = await fetch('/api/profiles/list');
        const result = await response.json();

        if (result.success) {
            const selector = document.getElementById('profileSelector');
            const profiles = result.data.slice(0, 4);

            selector.innerHTML = `
                <button class="btn btn-primary" data-profile="all">All</button>
                ${profiles.map(p => `
                    <button class="btn btn-secondary" data-profile="${p.id}" onclick="window.location.href='/profile/${p.id}'">
                        ${p.name}
                    </button>
                `).join('')}
            `;
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error loading profiles:', error);
    }
}

// Load dashboard data
async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard/overview');
        const result = await response.json();

        if (result.success) {
            const data = result.data;

            // Update KPIs
            updateKPI('trustScore', (data.key_metrics.avg_trust_score * 100).toFixed(0) + '%');
            updateKPI('inferences', formatNumber(data.key_metrics.total_daily_inferences));
            updateKPI('dailyCost', '$' + data.key_metrics.total_daily_cost.toFixed(0));
            updateKPI('carbonKg', data.key_metrics.total_daily_carbon_kg.toFixed(1) + ' kg');

            // Update health
            document.getElementById('healthyCount').textContent = data.health.healthy;
            document.getElementById('degradedCount').textContent = data.health.degraded;
            document.getElementById('unhealthyCount').textContent = data.health.unhealthy;

            // Update alerts
            document.getElementById('criticalAlerts').textContent = data.alerts.critical;
            document.getElementById('warningAlerts').textContent = data.alerts.warning;
            document.getElementById('infoAlerts').textContent = data.alerts.info;

            // Update trends
            updateTrend('trustTrend', data.trends.trust);
            updateTrend('costTrend', data.trends.cost);
            updateTrend('carbonTrend', data.trends.carbon);

            // Update top issues
            updateTopIssues(data.top_issues);
        } else {
            showToast(t('errors.load_failed') || 'Failed to load data', 'error');
        }
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast(t('errors.connection') || 'Connection error', 'error');

        // Remove skeletons on error
        ['trustScore', 'inferences', 'dailyCost', 'carbonKg'].forEach(id => {
            updateKPI(id, '-');
        });
    }
}

// Update KPI with value
function updateKPI(id, value) {
    const el = document.getElementById(id);
    if (el) {
        el.innerHTML = value;
    }
}

// Load services
async function loadServices() {
    try {
        const response = await fetch('/api/dashboard/services');
        const result = await response.json();

        if (result.success) {
            renderServicesTable(result.data);
        }
    } catch (error) {
        console.error('Error loading services:', error);
    }
}

// Render services table
function renderServicesTable(services) {
    const tbody = document.getElementById('servicesTableBody');

    if (!services || services.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state">
                    <i data-lucide="server-off"></i>
                    <h3>No services found</h3>
                </td>
            </tr>
        `;
        lucide.createIcons();
        return;
    }

    tbody.innerHTML = services.map(service => `
        <tr>
            <td><strong>${service.name}</strong></td>
            <td class="text-muted">${service.type}</td>
            <td>
                <span class="badge badge-${service.status}">
                    <span class="badge-dot"></span>
                    ${service.status}
                </span>
            </td>
            <td>${service.uptime_pct}%</td>
            <td>${service.error_rate_pct}%</td>
            <td>${service.latency_p99_ms}ms</td>
        </tr>
    `).join('');
}

// Initialize charts
function initCharts() {
    // Trust Score Chart
    const trustCtx = document.getElementById('trustChart').getContext('2d');
    trustChart = new Chart(trustCtx, {
        type: 'line',
        data: {
            labels: generateTimeLabels(24),
            datasets: [{
                label: 'Trust Score',
                data: generateDemoData(24, 0.75, 0.85),
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#64748b', font: { size: 11 } }
                },
                y: {
                    min: 0,
                    max: 1,
                    grid: { color: '#e2e8f0' },
                    ticks: {
                        color: '#64748b',
                        font: { size: 11 },
                        callback: v => (v * 100) + '%'
                    }
                }
            }
        }
    });

    // SLO Chart
    const sloCtx = document.getElementById('sloChart').getContext('2d');
    sloChart = new Chart(sloCtx, {
        type: 'doughnut',
        data: {
            labels: ['Compliant', 'At Risk', 'Violated'],
            datasets: [{
                data: [85, 10, 5],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 0,
                spacing: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: { size: 12 }
                    }
                }
            }
        }
    });

    // Time range handler
    document.getElementById('chartTimeRange').addEventListener('change', (e) => {
        const hours = parseInt(e.target.value);
        trustChart.data.labels = generateTimeLabels(hours);
        trustChart.data.datasets[0].data = generateDemoData(hours, 0.75, 0.85);
        trustChart.update();
    });
}

// Helper: Format number
function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
}

// Helper: Generate time labels
function generateTimeLabels(hours) {
    const labels = [];
    const now = new Date();
    const step = hours > 48 ? 24 : hours > 24 ? 6 : 1;

    for (let i = hours; i >= 0; i -= step) {
        const d = new Date(now - i * 3600000);
        labels.push(hours > 24 ? d.toLocaleDateString('en', { month: 'short', day: 'numeric' }) : d.getHours() + ':00');
    }
    return labels;
}

// Helper: Generate demo data
function generateDemoData(count, min, max) {
    const data = [];
    let value = (min + max) / 2;
    for (let i = 0; i < count; i++) {
        value += (Math.random() - 0.5) * 0.05;
        value = Math.max(min, Math.min(max, value));
        data.push(value);
    }
    return data;
}

// Update trend display
function updateTrend(elementId, trend) {
    const el = document.getElementById(elementId);
    if (!el) return;

    el.className = 'kpi-trend ' + trend;
    const icon = trend === 'up' ? 'trending-up' : trend === 'down' ? 'trending-down' : 'minus';
    el.innerHTML = `
        <i data-lucide="${icon}"></i>
        <span>${trend.charAt(0).toUpperCase() + trend.slice(1)}</span>
    `;
    lucide.createIcons();
}

// Update top issues
function updateTopIssues(issues) {
    const container = document.getElementById('topIssues');

    if (!issues || issues.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i data-lucide="check-circle"></i>
                <h3>No issues detected</h3>
                <p class="text-muted">All systems are running smoothly</p>
            </div>
        `;
        lucide.createIcons();
        return;
    }

    container.innerHTML = issues.map(issue => `
        <div class="flex items-center gap-4" style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
            <span class="badge badge-${issue.severity}">
                <span class="badge-dot"></span>
                ${issue.severity}
            </span>
            <div style="flex: 1;">
                <strong>${issue.title}</strong>
                <div class="text-sm text-muted">${issue.affected_service} - ${issue.duration_minutes} min</div>
            </div>
            <button class="btn btn-secondary" onclick="investigateIssue('${issue.id}')">
                <i data-lucide="search"></i>
                Investigate
            </button>
        </div>
    `).join('');
    lucide.createIcons();
}

// Investigate issue
function investigateIssue(issueId) {
    window.location.href = `/causal?issue=${issueId}`;
}

// Search services
document.getElementById('serviceSearch')?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#servicesTableBody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
});

// Narrative and Quick Tips management
function initNarrativeAndTips() {
    const narrativeDismissed = localStorage.getItem('aiobs-narrative-dismissed');
    const tipsDismissed = localStorage.getItem('aiobs-tips-dismissed');
    const onboardingComplete = localStorage.getItem('aiobs-onboarding-complete');

    // Hide narrative if already dismissed or onboarding was completed
    if (narrativeDismissed || onboardingComplete) {
        const narrative = document.getElementById('pageNarrative');
        if (narrative) narrative.style.display = 'none';
    }

    // Hide tips if dismissed
    if (tipsDismissed || onboardingComplete) {
        const tips = document.getElementById('quickTips');
        if (tips) tips.style.display = 'none';
    }
}

function dismissNarrative() {
    const narrative = document.getElementById('pageNarrative');
    if (narrative) {
        narrative.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => {
            narrative.style.display = 'none';
        }, 300);
    }
    localStorage.setItem('aiobs-narrative-dismissed', 'true');
}

function dismissTips() {
    const tips = document.getElementById('quickTips');
    if (tips) {
        tips.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => {
            tips.style.display = 'none';
        }, 300);
    }
    localStorage.setItem('aiobs-tips-dismissed', 'true');
}

// Initialize on page load
initNarrativeAndTips();
</script>
{% endblock %}
