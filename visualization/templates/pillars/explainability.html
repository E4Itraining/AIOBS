{% extends "pillars/base_pillars.html" %}

{% set active_pillar = 'explainability' %}

{% block page_title %}{{ t('pillars.explainability.name') or 'Explicabilité' }}{% endblock %}

{% block content %}
<!-- Pillar Header -->
<div class="pillar-header">
    <div class="pillar-header-info">
        <div class="pillar-header-icon explainability">
            <i data-lucide="lightbulb"></i>
        </div>
        <div class="pillar-header-text">
            <h1>{{ t('pillars.explainability.name') or 'Explicabilité' }}</h1>
            <span class="question">{{ t('pillars.explainability.question') or 'Pourquoi cette décision ?' }}</span>
        </div>
    </div>
    <div class="pillar-header-score">
        <div class="score-value" id="explainabilityScore" style="color: var(--pillar-explainability);">--</div>
        <div class="score-label">{{ t('pillars.score') or 'Score' }}</div>
        <div class="score-trend up" id="explainabilityTrend">
            <i data-lucide="trending-up"></i>
            <span>+3.1%</span>
        </div>
    </div>
</div>

<!-- KPI Grid -->
<div class="pillar-kpi-grid">
    <div class="pillar-kpi-card">
        <div class="pillar-kpi-header">
            <span class="pillar-kpi-label">{{ t('pillars.explainability.feature_importance') or 'Feature Importance' }}</span>
            <i data-lucide="list-ordered"></i>
        </div>
        <div class="pillar-kpi-value" id="featureImportance">92%</div>
        <div class="pillar-kpi-trend stable">
            <i data-lucide="check"></i> Disponible
        </div>
    </div>

    <div class="pillar-kpi-card">
        <div class="pillar-kpi-header">
            <span class="pillar-kpi-label">{{ t('pillars.explainability.confidence_scores') or 'Scores de Confiance' }}</span>
            <i data-lucide="gauge"></i>
        </div>
        <div class="pillar-kpi-value" id="confidenceAvg">87%</div>
        <div class="pillar-kpi-trend up">
            <i data-lucide="trending-up"></i> +2.5%
        </div>
    </div>

    <div class="pillar-kpi-card">
        <div class="pillar-kpi-header">
            <span class="pillar-kpi-label">{{ t('pillars.explainability.explanations_generated') or 'Explications Générées' }}</span>
            <i data-lucide="message-square"></i>
        </div>
        <div class="pillar-kpi-value" id="explanationsCount">45.2K</div>
        <div class="pillar-kpi-trend up">
            <i data-lucide="trending-up"></i> +18%
        </div>
    </div>

    <div class="pillar-kpi-card">
        <div class="pillar-kpi-header">
            <span class="pillar-kpi-label">{{ t('pillars.explainability.compliance_rate') or 'Taux Conformité Éthique' }}</span>
            <i data-lucide="heart"></i>
        </div>
        <div class="pillar-kpi-value" style="color: var(--color-success);" id="ethicsRate">100%</div>
        <div class="pillar-kpi-trend stable">
            <i data-lucide="shield-check"></i> OK
        </div>
    </div>
</div>

<!-- Feature Importance Section -->
<div class="pillar-section" id="features">
    <div class="pillar-section-header">
        <h2 class="pillar-section-title">
            <i data-lucide="list-ordered"></i>
            {{ t('pillars.explainability.feature_importance') or 'Feature Importance' }}
        </h2>
        <select class="form-select" style="width: auto;">
            <option value="fraud-detection">fraud-detection-v3</option>
            <option value="recommendation">recommendation-engine</option>
            <option value="pricing">pricing-model</option>
        </select>
    </div>

    <div class="grid grid-2 gap-4">
        <div class="card">
            <h4 class="text-sm text-muted mb-3">{{ t('pillars.explainability.top_features') or 'Top 10 Features' }}</h4>
            <div class="chart-container" style="height: 300px;">
                <canvas id="featureImportanceChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h4 class="text-sm text-muted mb-3">{{ t('pillars.explainability.feature_correlation') or 'Matrice de Corrélation' }}</h4>
            <div class="chart-container" style="height: 300px; display: flex; align-items: center; justify-content: center;">
                <div class="text-center">
                    <i data-lucide="grid-3x3" style="width: 64px; height: 64px; color: var(--text-muted);"></i>
                    <p class="text-muted mt-2">Heatmap de corrélation</p>
                    <button class="btn btn-secondary btn-sm mt-2">
                        <i data-lucide="maximize-2"></i>
                        Agrandir
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confidence Scores Section -->
<div class="pillar-section" id="confidence">
    <div class="pillar-section-header">
        <h2 class="pillar-section-title">
            <i data-lucide="gauge"></i>
            {{ t('pillars.explainability.confidence_scores') or 'Scores de Confiance' }}
        </h2>
    </div>

    <div class="grid grid-2 gap-4 mb-4">
        <div class="card">
            <h4 class="text-sm text-muted mb-2">{{ t('pillars.explainability.confidence_distribution') or 'Distribution des Scores' }}</h4>
            <div class="chart-container" style="height: 200px;">
                <canvas id="confidenceDistChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h4 class="text-sm text-muted mb-2">{{ t('pillars.explainability.low_confidence') or 'Prédictions Basse Confiance' }}</h4>
            <div class="flex justify-around text-center" style="height: 200px; align-items: center;">
                <div>
                    <div class="kpi-value" style="font-size: 3rem; color: var(--color-warning);">2.3%</div>
                    <div class="text-muted">< 70% confiance</div>
                </div>
                <div>
                    <div class="kpi-value" style="font-size: 3rem; color: var(--color-danger);">0.4%</div>
                    <div class="text-muted">< 50% confiance</div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>{{ t('table.model') or 'Modèle' }}</th>
                    <th>{{ t('pillars.explainability.avg_confidence') or 'Confiance Moy.' }}</th>
                    <th>{{ t('pillars.explainability.min_confidence') or 'Min' }}</th>
                    <th>{{ t('pillars.explainability.max_confidence') or 'Max' }}</th>
                    <th>{{ t('pillars.explainability.low_conf_pct') or '% Basse Conf.' }}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>fraud-detection-v3</strong></td>
                    <td>94.2%</td>
                    <td>62%</td>
                    <td>99.8%</td>
                    <td><span class="badge badge-healthy">1.2%</span></td>
                </tr>
                <tr>
                    <td><strong>recommendation-engine</strong></td>
                    <td>82.5%</td>
                    <td>45%</td>
                    <td>98.5%</td>
                    <td><span class="badge badge-warning">4.8%</span></td>
                </tr>
                <tr>
                    <td><strong>sentiment-analyzer</strong></td>
                    <td>88.1%</td>
                    <td>55%</td>
                    <td>99.2%</td>
                    <td><span class="badge badge-healthy">2.1%</span></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Alternatives Section -->
<div class="pillar-section" id="alternatives">
    <div class="pillar-section-header">
        <h2 class="pillar-section-title">
            <i data-lucide="git-compare"></i>
            {{ t('pillars.explainability.alternatives') or 'Alternatives Écartées' }}
        </h2>
    </div>

    <div class="card mb-4" style="background: linear-gradient(135deg, var(--pillar-explainability-light) 0%, var(--bg-card) 100%);">
        <div class="grid grid-3 gap-4 text-center">
            <div>
                <div class="kpi-value" style="color: var(--pillar-explainability);">78%</div>
                <div class="text-sm text-muted">Prédictions avec alternatives</div>
            </div>
            <div>
                <div class="kpi-value" style="color: var(--pillar-explainability);">3.2</div>
                <div class="text-sm text-muted">Alternatives moyennes/prédiction</div>
            </div>
            <div>
                <div class="kpi-value" style="color: var(--pillar-explainability);">15%</div>
                <div class="text-sm text-muted">Écart moyen avec 2ème choix</div>
            </div>
        </div>
    </div>

    <p class="text-muted mb-4">
        {{ t('pillars.explainability.alternatives_desc') or 'Les alternatives écartées permettent de comprendre pourquoi le modèle a choisi une prédiction plutôt qu\'une autre.' }}
    </p>

    <div class="example-prediction card">
        <h4 class="text-sm mb-3">{{ t('pillars.explainability.example') or 'Exemple de prédiction expliquée' }}</h4>
        <div class="flex gap-4">
            <div style="flex: 1;">
                <div class="text-sm text-muted">Prédiction choisie:</div>
                <div class="p-3 bg-success-light rounded-lg mt-1" style="border-left: 4px solid var(--color-success);">
                    <strong>Fraude détectée</strong> (93.2% confiance)
                </div>
            </div>
            <div style="flex: 1;">
                <div class="text-sm text-muted">Alternative 1:</div>
                <div class="p-3 bg-secondary rounded-lg mt-1" style="border-left: 4px solid var(--text-muted);">
                    <strong>Transaction suspecte</strong> (5.8%)
                </div>
            </div>
            <div style="flex: 1;">
                <div class="text-sm text-muted">Alternative 2:</div>
                <div class="p-3 bg-secondary rounded-lg mt-1" style="border-left: 4px solid var(--text-muted);">
                    <strong>Transaction normale</strong> (1.0%)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ethics & Legal Section -->
<div class="pillar-section" id="ethics">
    <div class="pillar-section-header">
        <h2 class="pillar-section-title">
            <i data-lucide="heart"></i>
            {{ t('pillars.explainability.ethics') or 'Obligations Légales et Éthiques' }}
        </h2>
        <span class="badge badge-healthy">Conforme</span>
    </div>

    <div class="grid grid-2 gap-4">
        <div>
            <h4 class="text-sm text-muted mb-3">{{ t('pillars.explainability.ethics_checklist') or 'Checklist Éthique' }}</h4>
            <div class="flex flex-col gap-2">
                <div class="flex items-center justify-between p-3 bg-secondary rounded-lg">
                    <span><i data-lucide="check-circle" class="inline-block w-4 h-4 mr-2" style="color: var(--color-success);"></i> Droit à l'explication (GDPR Art. 22)</span>
                    <span class="badge badge-healthy">OK</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-secondary rounded-lg">
                    <span><i data-lucide="check-circle" class="inline-block w-4 h-4 mr-2" style="color: var(--color-success);"></i> Absence de biais discriminatoire</span>
                    <span class="badge badge-healthy">OK</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-secondary rounded-lg">
                    <span><i data-lucide="check-circle" class="inline-block w-4 h-4 mr-2" style="color: var(--color-success);"></i> Transparence algorithmique</span>
                    <span class="badge badge-healthy">OK</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-secondary rounded-lg">
                    <span><i data-lucide="check-circle" class="inline-block w-4 h-4 mr-2" style="color: var(--color-success);"></i> Documentation des décisions</span>
                    <span class="badge badge-healthy">OK</span>
                </div>
            </div>
        </div>
        <div>
            <h4 class="text-sm text-muted mb-3">{{ t('pillars.explainability.bias_monitoring') or 'Monitoring des Biais' }}</h4>
            <div class="chart-container" style="height: 200px;">
                <canvas id="biasChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadExplainabilityData();
    initCharts();
    lucide.createIcons();
});

async function loadExplainabilityData() {
    try {
        const response = await fetch('/api/pillars/explainability');
        const data = await response.json();
        if (data.success) {
            document.getElementById('explainabilityScore').textContent = Math.round(data.data.score * 100) + '%';
        }
    } catch (error) {
        document.getElementById('explainabilityScore').textContent = '75%';
    }
}

function initCharts() {
    // Feature Importance Chart
    const featureCtx = document.getElementById('featureImportanceChart').getContext('2d');
    new Chart(featureCtx, {
        type: 'bar',
        data: {
            labels: ['transaction_amount', 'time_since_last', 'merchant_category', 'device_type', 'location_risk', 'velocity_24h', 'card_age', 'avg_transaction', 'failed_attempts', 'new_device'],
            datasets: [{
                label: 'Importance',
                data: [0.23, 0.18, 0.15, 0.12, 0.10, 0.08, 0.06, 0.04, 0.03, 0.01],
                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, max: 0.3 },
                y: { grid: { display: false } }
            }
        }
    });

    // Confidence Distribution Chart
    const confCtx = document.getElementById('confidenceDistChart').getContext('2d');
    new Chart(confCtx, {
        type: 'bar',
        data: {
            labels: ['0-50%', '50-60%', '60-70%', '70-80%', '80-90%', '90-100%'],
            datasets: [{
                label: 'Prédictions',
                data: [120, 340, 890, 2450, 8920, 32500],
                backgroundColor: ['#ef4444', '#f59e0b', '#f59e0b', '#3b82f6', '#3b82f6', '#10b981'],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false } },
                y: { type: 'logarithmic' }
            }
        }
    });

    // Bias Chart
    const biasCtx = document.getElementById('biasChart').getContext('2d');
    new Chart(biasCtx, {
        type: 'radar',
        data: {
            labels: ['Genre', 'Âge', 'Localisation', 'Revenu', 'Ethnicité'],
            datasets: [{
                label: 'Écart observé',
                data: [0.02, 0.03, 0.01, 0.04, 0.01],
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                pointBackgroundColor: '#8b5cf6'
            }, {
                label: 'Seuil acceptable',
                data: [0.05, 0.05, 0.05, 0.05, 0.05],
                borderColor: '#ef4444',
                backgroundColor: 'transparent',
                borderDash: [5, 5]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: { min: 0, max: 0.1, ticks: { stepSize: 0.02 } }
            },
            plugins: { legend: { position: 'bottom' } }
        }
    });
}
</script>
{% endblock %}
