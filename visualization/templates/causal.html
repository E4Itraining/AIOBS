{% extends "base.html" %}

{% set active_page = 'causal' %}

{% block page_title %}{{ t('nav.causal_analysis') }}{% endblock %}

{% block page_subtitle %}
<p>{{ t('causal.subtitle') or 'Root cause analysis linking infrastructure, data, and AI outcomes' }}</p>
{% endblock %}

{% block topbar_actions %}
<select id="scenarioSelect" class="form-select" style="width: auto;" onchange="loadScenario(this.value)">
    <option value="drift_incident">{{ t('causal.drift_incident') or 'Drift Incident' }}</option>
    <option value="cost_spike">{{ t('causal.cost_spike') or 'Cost Spike' }}</option>
</select>
{% endblock %}

{% block sidebar_extra %}
<div class="nav-group">
    <span class="nav-group-title">{{ t('causal.scenarios') or 'Scenarios' }}</span>
    <button class="nav-link" onclick="loadScenario('drift_incident')">
        <i data-lucide="alert-triangle"></i>
        <span>{{ t('causal.drift_incident') or 'Drift Incident' }}</span>
    </button>
    <button class="nav-link" onclick="loadScenario('cost_spike')">
        <i data-lucide="dollar-sign"></i>
        <span>{{ t('causal.cost_spike') or 'Cost Spike' }}</span>
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Causal Graph -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">{{ t('causal.graph') or 'Causal Graph' }}</h3>
        <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="resetGraph()">
                <i data-lucide="refresh-cw"></i>
                Reset
            </button>
        </div>
    </div>
    <div id="causalGraph" class="graph-container" style="height: 450px;"></div>
</div>

<!-- Root Causes & Impact Path -->
<div class="grid grid-2 mb-6">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ t('causal.root_causes') or 'Root Causes' }}</h3>
        </div>
        <div id="rootCauses">
            <div class="loader"><div class="spinner"></div></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ t('causal.impact_path') or 'Impact Path' }}</h3>
        </div>
        <div id="impactPath">
            <div class="loader"><div class="spinner"></div></div>
        </div>
    </div>
</div>

<!-- Node Details -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Node Details</h3>
    </div>
    <div id="nodeDetails" class="empty-state">
        <i data-lucide="mouse-pointer-click"></i>
        <h3>Click on a node</h3>
        <p class="text-muted">Click on a node in the graph to see details</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentGraph = null;

document.addEventListener('DOMContentLoaded', async () => {
    await loadScenario('drift_incident');
    lucide.createIcons();
});

async function loadScenario(scenario) {
    document.getElementById('scenarioSelect').value = scenario;

    try {
        const response = await fetch(`/api/metrics/causal/graph/${scenario}`);
        const result = await response.json();

        if (result.success) {
            currentGraph = result.data;
            renderCausalGraph(result.data);
            renderRootCauses(result.data);
            renderImpactPath(result.data);
        }
    } catch (error) {
        console.error('Error loading scenario:', error);
        showToast('Failed to load scenario', 'error');
    }
}

function resetGraph() {
    if (currentGraph) {
        renderCausalGraph(currentGraph);
    }
}

function renderCausalGraph(data) {
    const container = document.getElementById('causalGraph');
    container.innerHTML = '';

    const width = container.clientWidth || 800;
    const height = 450;

    const svg = d3.select(container)
        .append('svg')
        .attr('width', '100%')
        .attr('height', height)
        .attr('viewBox', `0 0 ${width} ${height}`);

    // Arrow marker
    svg.append('defs').append('marker')
        .attr('id', 'arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 35)
        .attr('refY', 0)
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', '#94a3b8');

    const typeColors = {
        data_source: '#3b82f6',
        feature: '#8b5cf6',
        model: '#10b981',
        configuration: '#f59e0b',
        infrastructure: '#6366f1',
        business_metric: '#ef4444',
        incident: '#dc2626',
        external_event: '#64748b'
    };

    const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.edges).id(d => d.id).distance(150))
        .force('charge', d3.forceManyBody().strength(-500))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(50));

    // Edges
    const link = svg.append('g').selectAll('g').data(data.edges).join('g');

    link.append('line')
        .attr('stroke', '#e2e8f0')
        .attr('stroke-width', d => 2 + d.weight * 3)
        .attr('marker-end', 'url(#arrow)');

    link.append('text')
        .text(d => (d.confidence * 100).toFixed(0) + '%')
        .attr('font-size', '10px')
        .attr('fill', '#64748b')
        .attr('text-anchor', 'middle');

    // Nodes
    const node = svg.append('g')
        .selectAll('g')
        .data(data.nodes)
        .join('g')
        .style('cursor', 'pointer')
        .on('click', (event, d) => showNodeDetails(d))
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));

    node.append('circle')
        .attr('r', 30)
        .attr('fill', d => typeColors[d.type] || '#6366f1')
        .attr('stroke', 'white')
        .attr('stroke-width', 3);

    node.append('text')
        .text(d => d.name.substring(0, 3).toUpperCase())
        .attr('text-anchor', 'middle')
        .attr('dy', 4)
        .attr('fill', 'white')
        .attr('font-size', '11px')
        .attr('font-weight', '600');

    node.append('text')
        .text(d => d.name)
        .attr('text-anchor', 'middle')
        .attr('dy', 50)
        .attr('fill', 'var(--text-primary)')
        .attr('font-size', '12px');

    // Impact indicator
    node.append('circle')
        .attr('cx', 20)
        .attr('cy', -20)
        .attr('r', 12)
        .attr('fill', d => d.impact_score > 0.7 ? '#ef4444' :
            d.impact_score > 0.4 ? '#f59e0b' : '#10b981');

    node.append('text')
        .text(d => (d.impact_score * 10).toFixed(0))
        .attr('x', 20)
        .attr('y', -16)
        .attr('text-anchor', 'middle')
        .attr('fill', 'white')
        .attr('font-size', '9px')
        .attr('font-weight', '600');

    simulation.on('tick', () => {
        link.selectAll('line')
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        link.selectAll('text')
            .attr('x', d => (d.source.x + d.target.x) / 2)
            .attr('y', d => (d.source.y + d.target.y) / 2 - 10);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }
}

function renderRootCauses(data) {
    const targetIds = new Set(data.edges.map(e => e.target));
    const rootCauses = data.nodes.filter(n => !targetIds.has(n.id));
    const container = document.getElementById('rootCauses');

    if (!rootCauses.length) {
        container.innerHTML = `
            <div class="empty-state">
                <i data-lucide="search"></i>
                <h3>No root causes identified</h3>
            </div>
        `;
        lucide.createIcons();
        return;
    }

    container.innerHTML = rootCauses.map(rc => `
        <div class="flex items-center gap-4" style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
            <div style="width: 48px; height: 48px; border-radius: 50%; background: ${rc.impact_score > 0.7 ? 'var(--color-danger)' : 'var(--color-warning)'}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                ${(rc.impact_score * 100).toFixed(0)}%
            </div>
            <div style="flex: 1;">
                <div class="font-semibold">${rc.name}</div>
                <div class="text-sm text-muted">${rc.description || rc.type.replace(/_/g, ' ')}</div>
            </div>
        </div>
    `).join('');
}

function renderImpactPath(data) {
    const paths = data.edges.map(edge => {
        const source = data.nodes.find(n => n.id === edge.source);
        const target = data.nodes.find(n => n.id === edge.target);
        return source && target ? { source, target, ...edge } : null;
    }).filter(Boolean);

    const container = document.getElementById('impactPath');

    if (!paths.length) {
        container.innerHTML = `
            <div class="empty-state">
                <i data-lucide="git-branch"></i>
                <h3>No impact paths</h3>
            </div>
        `;
        lucide.createIcons();
        return;
    }

    container.innerHTML = paths.map(p => `
        <div class="flex items-center gap-2" style="padding: 0.75rem; border-bottom: 1px solid var(--border-color);">
            <span class="font-semibold">${p.source.name}</span>
            <i data-lucide="arrow-right" style="width: 16px; height: 16px; color: var(--text-tertiary);"></i>
            <span class="font-semibold">${p.target.name}</span>
            <span class="badge ${p.confidence > 0.8 ? 'badge-healthy' : 'badge-warning'}" style="margin-left: auto;">
                ${(p.confidence * 100).toFixed(0)}%
            </span>
        </div>
    `).join('');
    lucide.createIcons();
}

function showNodeDetails(node) {
    const container = document.getElementById('nodeDetails');
    container.innerHTML = `
        <div class="grid grid-2 gap-4">
            <div>
                <div class="text-sm text-muted mb-1">Name</div>
                <div class="font-semibold" style="font-size: 1.25rem;">${node.name}</div>
            </div>
            <div>
                <div class="text-sm text-muted mb-1">Type</div>
                <div class="font-semibold">${node.type.replace(/_/g, ' ')}</div>
            </div>
            <div>
                <div class="text-sm text-muted mb-1">Impact Score</div>
                <div class="kpi-value" style="color: ${node.impact_score > 0.7 ? 'var(--color-danger)' : node.impact_score > 0.4 ? 'var(--color-warning)' : 'var(--color-success)'};">
                    ${(node.impact_score * 100).toFixed(0)}%
                </div>
            </div>
            <div>
                <div class="text-sm text-muted mb-1">Description</div>
                <div>${node.description || 'No description available'}</div>
            </div>
        </div>
    `;
}
</script>
{% endblock %}
